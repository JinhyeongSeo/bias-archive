---
phase: 11-bias-schema-extension
plan: 01
type: execute
depends_on: []
files_modified:
  - supabase/migrations/20260114000001_bias_multilingual.sql
  - src/types/database.ts
  - src/lib/biases.ts
  - src/app/api/biases/route.ts
  - src/app/api/biases/[id]/route.ts
  - src/app/api/biases/batch/route.ts
  - src/components/BiasManager.tsx
---

<objective>
biases 테이블에 name_en/name_ko 필드를 추가하여 다국어 최애 이름 저장을 지원한다.

Purpose: 영어/한글 이름을 별도로 저장하여 Phase 12의 언어 토글 UI와 Phase 13의 양방향 태그 매칭을 가능하게 함.
Output: 확장된 DB 스키마, 업데이트된 API, 다국어 지원 UI.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files (relevant to this phase):
@src/types/database.ts
@src/lib/biases.ts
@src/app/api/biases/route.ts
@src/app/api/biases/batch/route.ts
@src/components/BiasManager.tsx

**Tech stack available:** Next.js 15, Supabase, TypeScript, Tailwind CSS
**Established patterns:**
- Supabase migration via `npx supabase db push`
- Korean names (name_original) stored for tag matching (from Phase 10)
- kpopnet.json 패키지에서 name(영어), name_original(한글) 제공

**Constraining decisions:**
- [Phase 10]: 한글 이름(name_original)을 저장하여 태그 매칭 지원
- 기존 `name` 필드에는 한글 이름이 저장되어 있음
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB 스키마 확장 및 TypeScript 타입 업데이트</name>
  <files>supabase/migrations/20260114000001_bias_multilingual.sql, src/types/database.ts</files>
  <action>
1. 새 migration 파일 생성:
   - `name_en TEXT` 컬럼 추가 (영어 이름, nullable)
   - `name_ko TEXT` 컬럼 추가 (한글 이름, nullable)
   - 기존 데이터 마이그레이션: `UPDATE biases SET name_ko = name WHERE name_ko IS NULL`
   - 기존 `name` 컬럼은 유지 (하위 호환성, display name으로 활용)

2. TypeScript 타입 업데이트 (src/types/database.ts):
   - biases 테이블 Row에 `name_en: string | null`, `name_ko: string | null` 추가
   - Insert/Update 타입에도 동일하게 추가
  </action>
  <verify>
npx supabase db push 성공
npm run build 에러 없음
  </verify>
  <done>
- Migration 적용됨 (biases 테이블에 name_en, name_ko 컬럼 존재)
- 기존 데이터가 name_ko로 복사됨
- TypeScript 빌드 에러 없음
  </done>
</task>

<task type="auto">
  <name>Task 2: API 및 CRUD 함수 업데이트</name>
  <files>src/lib/biases.ts, src/app/api/biases/route.ts, src/app/api/biases/[id]/route.ts, src/app/api/biases/batch/route.ts</files>
  <action>
1. src/lib/biases.ts 업데이트:
   - `createBias(name, groupName, nameEn?, nameKo?)` 시그니처 확장
   - `updateBias(id, name, groupName, nameEn?, nameKo?)` 시그니처 확장
   - Insert/Update 시 name_en, name_ko 포함

2. POST /api/biases 업데이트:
   - body에서 `nameEn`, `nameKo` 파라미터 추출
   - createBias 호출 시 전달

3. PUT /api/biases/[id] 업데이트:
   - body에서 `nameEn`, `nameKo` 파라미터 추출
   - updateBias 호출 시 전달

4. POST /api/biases/batch 업데이트:
   - members 배열에서 `nameEn`, `nameKo` 추출하여 저장
   - kpopnet 데이터 구조: name(영어), name_original(한글)
  </action>
  <verify>
curl -X POST /api/biases -d '{"name":"테스트","nameEn":"Test","nameKo":"테스트"}' -H "Content-Type: application/json" 성공
npm run build 에러 없음
  </verify>
  <done>
- 개별 추가 API가 name_en, name_ko 저장
- 일괄 추가 API가 name_en, name_ko 저장
- 기존 API 호환성 유지 (name만 전달해도 동작)
  </done>
</task>

<task type="auto">
  <name>Task 3: BiasManager UI 업데이트</name>
  <files>src/components/BiasManager.tsx</files>
  <action>
1. 개별 추가 폼 확장:
   - 기존 "이름" 필드를 "이름 (표시용)" 유지
   - "영어 이름 (선택)" 필드 추가
   - "한글 이름 (선택)" 필드 추가
   - API 호출 시 nameEn, nameKo 포함

2. 그룹 멤버 일괄 추가 로직 수정:
   - kpopnet 데이터에서 name → nameEn, name_original → nameKo로 매핑
   - batch API 호출 시 전체 데이터 전달
   - 기존 `name` 필드는 nameKo 값 사용 (태그 매칭용)

3. 최애 목록 표시는 기존 유지 (name 필드 사용, Phase 12에서 언어 모드에 따라 변경)
  </action>
  <verify>
npm run build 에러 없음
개발 서버에서 최애 추가 폼에 3개 필드 표시
그룹 일괄 추가 후 DB에 name_en, name_ko 저장 확인
  </verify>
  <done>
- 개별 추가 시 영어/한글 이름 입력 가능
- 그룹 일괄 추가 시 자동으로 영어/한글 이름 저장
- 빌드 에러 없음
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx supabase db push` 성공 (migration 적용)
- [ ] `npm run build` 에러 없음
- [ ] 개별 최애 추가 시 name_en, name_ko 저장됨
- [ ] 그룹 일괄 추가 시 name_en, name_ko 자동 저장됨
- [ ] 기존 기능 정상 동작 (태그 매칭 등)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- biases 테이블에 name_en, name_ko 컬럼 존재
- 기존 데이터 마이그레이션 완료 (name → name_ko)
- API가 다국어 이름 저장 지원
- UI가 다국어 이름 입력 지원
</success_criteria>

<output>
After completion, create `.planning/phases/11-bias-schema-extension/11-01-SUMMARY.md`
</output>
