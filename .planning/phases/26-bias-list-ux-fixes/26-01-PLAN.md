---
phase: 26-bias-list-ux-fixes
plan: 01
type: execute
depends_on: []
files_modified:
  - src/app/api/biases/route.ts
  - src/app/api/biases/batch/route.ts
  - src/app/api/groups/route.ts
  - src/components/Sidebar.tsx
---

<objective>
Bias List UX 버그 수정: 그룹 순서 변경 시 통합검색 실시간 반영, 최애/그룹 추가 시 목록 아래에 추가

Purpose: 사용자가 그룹 순서를 변경하면 통합검색에도 즉시 반영되어 일관된 UX 제공, 새 항목이 목록 아래에 추가되어 직관적인 동작
Output: 그룹 순서 변경 시 UnifiedSearch 동기화, 새 항목 추가 시 목록 맨 아래에 표시
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**관련 파일:**
@src/app/api/biases/route.ts
@src/app/api/biases/batch/route.ts
@src/app/api/groups/route.ts
@src/components/BiasManager.tsx
@src/components/Sidebar.tsx
@src/app/[locale]/page.tsx

**이전 결정 (Phase 16, 23):**
- sort_order 컬럼으로 순서 관리
- onBiasChange 콜백으로 BiasManager 변경 시 통합검색 갱신
- 정렬: sort_order ASC nullsFirst: false, 그 다음 created_at DESC

**문제 분석:**
1. 그룹 순서 변경: BiasManager의 onBiasReordered가 Sidebar의 onBiasChange를 호출 → fetchBiasesAndGroups 실행 → UnifiedSearch에 전달됨 (이미 동작함)
   - 실제 문제: Sidebar에서 onBiasReordered를 onBiasChange에 연결하지 않음
2. 추가 위치: sort_order가 NULL인 새 항목이 created_at DESC로 인해 맨 위에 표시됨
   - 해결: 새 항목 추가 시 max(sort_order) + 1 값 설정
</context>

<tasks>

<task type="auto">
  <name>Task 1: API - 새 bias/group 추가 시 sort_order를 max+1로 설정</name>
  <files>src/app/api/biases/route.ts, src/app/api/biases/batch/route.ts, src/app/api/groups/route.ts</files>
  <action>
각 POST API에서 새 항목 추가 시 현재 max(sort_order)를 조회하고 +1한 값을 설정:

**biases/route.ts POST:**
```typescript
// 새 bias의 sort_order를 max+1로 설정
const { data: maxData } = await supabase
  .from('biases')
  .select('sort_order')
  .order('sort_order', { ascending: false, nullsFirst: false })
  .limit(1)
  .single()

const nextSortOrder = (maxData?.sort_order ?? 0) + 1
```
biasInsert에 sort_order: nextSortOrder 추가

**biases/batch/route.ts POST:**
배치 추가 시에도 동일하게 max 조회 후 순차 할당:
```typescript
const { data: maxData } = await supabase
  .from('biases')
  .select('sort_order')
  .order('sort_order', { ascending: false, nullsFirst: false })
  .limit(1)
  .single()

let nextSortOrder = (maxData?.sort_order ?? 0) + 1

const insertData: BiasInsert[] = newMembers.map((member, index) => ({
  ...기존필드,
  sort_order: nextSortOrder + index,
}))
```

**groups/route.ts POST:**
동일 패턴으로 groups 테이블에도 적용
  </action>
  <verify>
1. bias 추가: curl -X POST /api/biases -d '{"name":"테스트"}' 후 GET /api/biases에서 맨 아래에 표시
2. group 추가: curl -X POST /api/groups -d '{"name":"테스트그룹"}' 후 GET /api/groups에서 맨 아래에 표시
3. batch 추가: curl -X POST /api/biases/batch 후 모든 멤버가 기존 목록 아래에 순서대로 추가
  </verify>
  <done>
- 새로 추가된 bias가 기존 목록 맨 아래에 표시
- 새로 추가된 group이 기존 목록 맨 아래에 표시
- 배치 추가된 멤버들이 순서대로 기존 목록 아래에 추가
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidebar - onBiasReordered를 onBiasChange에 연결</name>
  <files>src/components/Sidebar.tsx</files>
  <action>
Sidebar 컴포넌트에서 BiasManager의 onBiasReordered prop에 onBiasChange를 전달:

현재 BiasManager에 전달하는 props 확인:
```tsx
<BiasManager
  biases={biases}
  groups={groups}
  onBiasAdded={handleBiasChange}
  onBiasDeleted={handleBiasChange}
  // onBiasReordered가 누락됨
/>
```

수정:
```tsx
<BiasManager
  biases={biases}
  groups={groups}
  onBiasAdded={handleBiasChange}
  onBiasDeleted={handleBiasChange}
  onBiasReordered={handleBiasChange}  // 추가
/>
```

handleBiasChange가 onBiasChange를 호출하면, page.tsx의 onBiasChange가 fetchBiasesAndGroups를 실행하여 UnifiedSearch에 전달되는 biases, groups가 갱신됨.
  </action>
  <verify>
1. BiasManager에서 그룹 순서를 드래그로 변경
2. 통합검색 열기
3. 아이돌 선택 드롭다운에서 그룹 순서가 변경된 순서대로 표시되는지 확인
  </verify>
  <done>
- BiasManager에서 그룹 순서 변경 시 통합검색 드롭다운에 즉시 반영
- 기존 add/delete 동작에 영향 없음
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build 성공
- [ ] 새 bias 추가 시 목록 맨 아래에 표시
- [ ] 새 group 추가 시 목록 맨 아래에 표시
- [ ] 그룹으로 멤버 일괄 추가 시 기존 목록 아래에 순서대로 추가
- [ ] BiasManager에서 그룹 순서 변경 후 통합검색에 즉시 반영
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- 새 항목이 목록 아래에 추가되는 직관적인 UX
- 그룹 순서 변경이 통합검색에 실시간 반영
- Phase 26 complete
</success_criteria>

<output>
After completion, create `.planning/phases/26-bias-list-ux-fixes/26-01-SUMMARY.md`:

# Phase 26 Plan 01: Bias List UX Fixes Summary

**[한 줄 요약]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for next phase
</output>
