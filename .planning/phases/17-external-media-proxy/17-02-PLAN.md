---
phase: 17-external-media-proxy
plan: 02
type: execute
depends_on: ["17-01"]
files_modified: [cloudflare-worker/video-proxy.js, src/lib/proxy.ts, src/components/EmbedViewer.tsx, src/components/LinkCard.tsx]
---

<objective>
Cloudflare Workers로 비디오 프록시 배포하여 핫링크 보호된 비디오 재생 지원

Purpose: kgirls.net 비디오 콘텐츠의 인앱 재생 지원 (현재 403 에러 발생)
Output: Cloudflare Worker 배포, 비디오 프록시 함수, 컴포넌트 적용
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-external-media-proxy/17-01-SUMMARY.md
@src/lib/proxy.ts
@src/components/EmbedViewer.tsx
@src/components/LinkCard.tsx

**Cloudflare Workers 무료 tier:**
- 하루 100,000 요청
- 분당 1,000 요청
- 개인 비영리 프로젝트로 충분

**비디오 프록시 필요 이유:**
- kgirls.net 비디오(.mp4, .mov)는 핫링크 보호됨
- Referer 헤더 없으면 403 Forbidden
- wsrv.nl은 이미지 전용 (비디오 미지원)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cloudflare Worker 비디오 프록시 코드 작성</name>
  <files>cloudflare-worker/video-proxy.js</files>
  <action>
Cloudflare Worker로 비디오 프록시 생성:

```javascript
// URL 파라미터로 비디오 URL 받음
// 허용된 도메인만 프록시 (kgirls.net)
// Referer 헤더 추가하여 원본 서버에 요청
// 스트리밍 응답 반환 (Range 헤더 지원)
```

보안 고려사항:
- 허용된 도메인 화이트리스트 적용
- Content-Type 검증 (video/* 만 허용)
- 파일 크기 제한 (100MB)

파일 위치: 프로젝트 루트 cloudflare-worker/ 디렉토리
  </action>
  <verify>Worker 코드 문법 에러 없음</verify>
  <done>cloudflare-worker/video-proxy.js 생성</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Cloudflare Workers에 비디오 프록시 배포</action>
  <instructions>
Worker 코드를 Cloudflare에 배포:

1. Cloudflare 대시보드 접속: https://dash.cloudflare.com
2. Workers & Pages → Create Worker
3. "Edit code" 클릭
4. cloudflare-worker/video-proxy.js 내용 붙여넣기
5. "Save and Deploy" 클릭
6. Worker URL 복사 (예: https://video-proxy.{계정}.workers.dev)

또는 wrangler CLI 사용:
```bash
npm install -g wrangler
wrangler login
cd cloudflare-worker
wrangler deploy
```
  </instructions>
  <verification>Worker URL이 브라우저에서 접근 가능</verification>
  <resume-signal>배포 완료 후 Worker URL 입력 (예: https://video-proxy.username.workers.dev)</resume-signal>
</task>

<task type="auto">
  <name>Task 2: 비디오 프록시 함수 추가 및 컴포넌트 적용</name>
  <files>src/lib/proxy.ts, src/components/EmbedViewer.tsx, src/components/LinkCard.tsx</files>
  <action>
1. src/lib/proxy.ts에 비디오 프록시 함수 추가:
   - getProxiedVideoUrl(url: string): string
   - VIDEO_PROXY_BASE_URL 환경변수 또는 상수 사용
   - kgirls.net 비디오만 프록시, 나머지는 원본 URL

2. EmbedViewer.tsx (MediaGallery):
   - video src에 getProxiedVideoUrl() 적용

3. LinkCard.tsx:
   - 비디오 썸네일(isVideoUrl)에 getProxiedVideoUrl() 적용

Worker URL은 환경변수 NEXT_PUBLIC_VIDEO_PROXY_URL로 설정 권장
(없으면 원본 URL 사용하여 graceful degradation)
  </action>
  <verify>npm run build 성공</verify>
  <done>비디오 프록시 함수 추가, 컴포넌트에서 kgirls 비디오 프록시 사용</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Cloudflare Worker 배포 완료
- [ ] `npm run build` 성공
- [ ] kgirls.net 비디오 링크 저장 → 비디오 재생 확인
- [ ] EmbedViewer에서 kgirls 비디오 갤러리 재생 확인
</verification>

<success_criteria>
- Cloudflare Worker 비디오 프록시 배포됨
- kgirls.net 비디오가 인앱에서 재생됨
- heye.kr는 이미지만 지원 (비디오 없음)
- Phase 17 complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-external-media-proxy/17-02-SUMMARY.md`
</output>
