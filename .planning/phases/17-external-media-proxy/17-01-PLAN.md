---
phase: 17-external-media-proxy
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/proxy.ts, src/components/ExternalSearch.tsx, src/components/EmbedViewer.tsx, src/components/LinkCard.tsx]
---

<objective>
wsrv.nl 이미지 프록시로 전환하여 핫링크 보호된 이미지를 외부 무료 서비스로 처리

Purpose: Vercel 서버리스 함수 부하 감소, 글로벌 Cloudflare 캐싱으로 성능 향상
Output: 이미지 프록시 헬퍼 함수, 컴포넌트에 wsrv.nl 적용
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/api/proxy/image/route.ts
@src/components/ExternalSearch.tsx
@src/components/EmbedViewer.tsx
@src/components/LinkCard.tsx

**현재 프록시 사용처:**
- ExternalSearch.tsx:265 - kgirls 검색 결과 썸네일에 `/api/proxy/image` 사용
- EmbedViewer.tsx - 저장된 미디어 URL 직접 사용 (프록시 없음)
- LinkCard.tsx - 저장된 썸네일 URL 직접 사용 (프록시 없음)

**wsrv.nl 서비스:**
- 무료 이미지 캐시 & 리사이즈 서비스
- Cloudflare 300+ 데이터센터 글로벌 캐싱
- 사용법: `https://wsrv.nl/?url={encodedImageUrl}`
- Referer 헤더 자동 처리 (핫링크 보호 우회)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 이미지 프록시 헬퍼 함수 생성</name>
  <files>src/lib/proxy.ts</files>
  <action>
프록시가 필요한 URL인지 판단하고 wsrv.nl URL로 변환하는 헬퍼 함수 생성:

```typescript
// 핫링크 보호된 도메인 목록
const HOTLINK_PROTECTED_DOMAINS = ['heye.kr', 'kgirls.net']

// URL이 프록시가 필요한지 확인
export function needsProxy(url: string): boolean

// wsrv.nl 프록시 URL 생성
export function getProxiedImageUrl(url: string): string
```

- heye.kr (img1.heye.kr 포함), kgirls.net 도메인만 프록시
- 다른 도메인은 원본 URL 그대로 반환
- wsrv.nl URL 형식: `https://wsrv.nl/?url={encodedUrl}`
  </action>
  <verify>TypeScript 컴파일 에러 없음</verify>
  <done>src/lib/proxy.ts 생성, needsProxy/getProxiedImageUrl 함수 export</done>
</task>

<task type="auto">
  <name>Task 2: 컴포넌트에 wsrv.nl 프록시 적용</name>
  <files>src/components/ExternalSearch.tsx, src/components/EmbedViewer.tsx, src/components/LinkCard.tsx</files>
  <action>
1. ExternalSearch.tsx:
   - `/api/proxy/image?url=` → `getProxiedImageUrl()` 변경
   - heye.kr 검색 결과 썸네일에도 프록시 적용

2. EmbedViewer.tsx (MediaGallery):
   - Image src에 getProxiedImageUrl() 적용
   - video src는 프록시 적용하지 않음 (wsrv.nl은 이미지 전용)

3. LinkCard.tsx:
   - thumbnail_url이 이미지인 경우 getProxiedImageUrl() 적용
   - video URL은 그대로 유지

주의: 이미지만 프록시 적용, 비디오(.mp4, .webm, .mov)는 제외
  </action>
  <verify>npm run build 성공, 개발 서버에서 heye/kgirls 이미지 표시 확인</verify>
  <done>세 컴포넌트 모두 wsrv.nl 프록시 사용, 이미지 정상 로드</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] heye.kr 링크 저장 → 썸네일 이미지 표시 확인
- [ ] kgirls.net 링크 저장 → 썸네일/갤러리 이미지 표시 확인
- [ ] 외부 검색에서 heye/kgirls 결과 썸네일 표시 확인
</verification>

<success_criteria>
- 이미지 프록시 헬퍼 함수 생성됨
- heye.kr, kgirls.net 이미지가 wsrv.nl 통해 로드됨
- 비디오는 프록시 없이 원본 URL 사용
- 빌드 에러 없음
</success_criteria>

<output>
After completion, create `.planning/phases/17-external-media-proxy/17-01-SUMMARY.md`
</output>
