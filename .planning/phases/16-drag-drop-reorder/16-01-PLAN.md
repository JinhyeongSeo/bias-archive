---
phase: 16-drag-drop-reorder
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/20260114000003_bias_sort_order.sql, src/types/database.ts, src/app/api/biases/reorder/route.ts, src/app/api/biases/route.ts]
---

<objective>
biases 테이블에 sort_order 컬럼을 추가하고 순서 변경 API를 구현한다.

Purpose: 드래그 앤 드롭으로 변경된 최애 순서를 DB에 영구 저장할 수 있게 한다.
Output: sort_order 컬럼이 추가된 스키마, 순서 변경 API 엔드포인트
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-drag-drop-reorder/DISCOVERY.md
@src/types/database.ts
@src/app/api/biases/route.ts
@supabase/migrations/20260114000002_groups_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: biases 테이블에 sort_order 컬럼 추가</name>
  <files>supabase/migrations/20260114000003_bias_sort_order.sql</files>
  <action>
새 마이그레이션 파일 생성:
1. biases 테이블에 sort_order INTEGER 컬럼 추가 (nullable, 기본값 없음)
2. 기존 데이터에 created_at 순으로 sort_order 값 할당 (1부터 시작)
3. sort_order에 인덱스 추가 (정렬 성능)

주의: NOT NULL 제약 조건 추가하지 않음 - 기존 데이터 호환성 및 새 레코드 기본값 처리 용이
  </action>
  <verify>npx supabase db push 실행 후 에러 없음</verify>
  <done>biases 테이블에 sort_order 컬럼 존재, 기존 데이터에 순서 값 할당됨</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript 타입 업데이트</name>
  <files>src/types/database.ts</files>
  <action>
biases 테이블 타입에 sort_order 필드 추가:
- Row: sort_order: number | null
- Insert: sort_order?: number | null
- Update: sort_order?: number | null
  </action>
  <verify>npm run build 타입 에러 없음</verify>
  <done>Bias 타입에 sort_order 필드 포함</done>
</task>

<task type="auto">
  <name>Task 3: 순서 변경 API 엔드포인트 구현</name>
  <files>src/app/api/biases/reorder/route.ts, src/app/api/biases/route.ts</files>
  <action>
1. PUT /api/biases/reorder 엔드포인트 생성:
   - Request body: { orderedIds: string[] } - 새 순서대로 정렬된 bias ID 배열
   - 각 ID에 대해 sort_order를 배열 인덱스+1로 업데이트
   - 트랜잭션 또는 순차 업데이트로 처리

2. GET /api/biases 수정:
   - 조회 시 sort_order 기준 정렬 추가 (NULLS LAST)
   - sort_order가 null인 경우 created_at 순으로 폴백

주의: 그룹 내 정렬도 고려 - 같은 그룹 내에서 sort_order 순으로 정렬
  </action>
  <verify>curl -X PUT /api/biases/reorder -d '{"orderedIds":["id1","id2"]}' 200 반환</verify>
  <done>순서 변경 API 동작, biases 조회 시 sort_order 순 정렬</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx supabase db push` 성공
- [ ] `npm run build` 타입 에러 없음
- [ ] GET /api/biases가 sort_order 순으로 정렬된 결과 반환
- [ ] PUT /api/biases/reorder가 순서 업데이트 성공
</verification>

<success_criteria>

- 모든 tasks 완료
- DB 스키마에 sort_order 컬럼 존재
- API 엔드포인트 정상 동작
- 타입 정의 업데이트 완료
</success_criteria>

<output>
After completion, create `.planning/phases/16-drag-drop-reorder/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Schema & API Summary

**[한 줄 요약]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 16-02-PLAN.md (UI 드래그 앤 드롭 구현)
</output>
