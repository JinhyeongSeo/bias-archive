---
phase: 03-tagging-multi-bias
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [src/lib/tags.ts, src/lib/autoTag.ts, src/app/api/tags/route.ts, src/app/api/links/route.ts, src/lib/parsers/index.ts]
---

<objective>
자동 태그 추출 로직 구현 - 제목/설명에서 멤버명 감지 및 태그 자동 생성

Purpose: 링크 저장 시 등록된 최애 멤버명을 자동으로 태그로 추출하여 분류 편의성 향상
Output: 자동 태그 추출 함수 + 태그 CRUD API + 링크 저장 시 자동 태그 연결
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-tagging-multi-bias/03-01-SUMMARY.md

**Prior decisions:**
- biases 테이블에 name, group_name 저장
- links 테이블에 title, description, author_name 저장
- author_name에 이미 Weverse 멤버명 추출됨

**Tech stack:**
- tags, link_tags 테이블 이미 존재
- Next.js API Routes

**Key files:**
@src/lib/biases.ts
@src/app/api/links/route.ts
@src/lib/parsers/weverse.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 태그 CRUD API 및 유틸 함수</name>
  <files>src/lib/tags.ts, src/app/api/tags/route.ts</files>
  <action>
1. `src/lib/tags.ts` 생성:
   - getTags(): 전체 태그 목록 (name ASC)
   - getTagByName(name): 이름으로 조회
   - createTag(name): 태그 생성 (중복 시 기존 반환)
   - getOrCreateTag(name): 있으면 조회, 없으면 생성
   - deleteTag(id): 삭제
   - addTagToLink(linkId, tagId): link_tags에 연결
   - removeTagFromLink(linkId, tagId): 연결 해제
   - getTagsForLink(linkId): 링크의 태그 목록

2. `src/app/api/tags/route.ts`:
   - GET: getTags() 호출
   - POST: body에서 name 추출, createTag() 호출

에러 처리: 기존 패턴 따를 것
  </action>
  <verify>
curl -X POST http://localhost:3000/api/tags -H "Content-Type: application/json" -d '{"name":"직캠"}' 반환 확인
curl http://localhost:3000/api/tags 목록 반환 확인
  </verify>
  <done>태그 CRUD API 동작, getOrCreateTag 함수 사용 가능</done>
</task>

<task type="auto">
  <name>Task 2: 자동 태그 추출 로직</name>
  <files>src/lib/autoTag.ts</files>
  <action>
1. `src/lib/autoTag.ts` 생성:
   - extractAutoTags(text, biases): 텍스트에서 등록된 bias 이름 찾기
   - 입력: title + description + author_name 결합 문자열
   - 비교: 대소문자 무시, 부분 일치 (단어 경계 고려)
   - 반환: 매칭된 bias 이름 배열

2. 매칭 로직:
   - biases 목록에서 name과 group_name 모두 검색
   - 예: "RORA fancam" → biases에 "RORA" 있으면 ["RORA"] 반환
   - 예: "BABYMONSTER" → group_name이 "BABYMONSTER"인 모든 멤버 반환
   - 한글/영문 모두 지원

3. 태그 정규화:
   - 공백 trim
   - 중복 제거
  </action>
  <verify>
테스트 코드로 확인:
const biases = [{name: 'RORA', group_name: 'BABYMONSTER'}]
extractAutoTags('RORA fancam video', biases) → ['RORA']
  </verify>
  <done>자동 태그 추출 함수가 bias 이름을 정확히 감지함</done>
</task>

<task type="auto">
  <name>Task 3: 링크 저장 시 자동 태그 연결</name>
  <files>src/app/api/links/route.ts</files>
  <action>
1. POST /api/links 수정:
   - 링크 저장 후 extractAutoTags() 호출
   - 입력: title + ' ' + (description || '') + ' ' + (author_name || '')
   - biases는 getBiases()로 조회

2. 태그 생성 및 연결:
   - 추출된 각 태그명에 대해 getOrCreateTag() 호출
   - addTagToLink(linkId, tagId)로 연결

3. 응답에 tags 포함:
   - 생성된 링크 + 연결된 태그 목록 반환
   - 기존 응답 구조 유지하면서 tags 필드 추가

주의: 기존 동작 깨지지 않게 조심할 것
  </action>
  <verify>
1. curl로 YouTube/Twitter URL 저장
2. 응답에 tags 배열 포함 확인
3. DB에서 link_tags 테이블에 연결 확인
  </verify>
  <done>링크 저장 시 자동 태그가 추출되고 link_tags에 연결됨</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 에러 없음
- [ ] GET /api/tags 목록 반환
- [ ] POST /api/tags 태그 생성
- [ ] 링크 저장 시 bias 이름이 자동으로 태그에 추가됨
- [ ] link_tags 테이블에 연결 저장됨
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- 자동 태그 추출이 링크 저장 흐름에 통합됨
</success_criteria>

<output>
After completion, create `.planning/phases/03-tagging-multi-bias/03-02-SUMMARY.md`
</output>
