---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [.env.local, src/lib/supabase.ts, src/types/database.ts, supabase/migrations/001_initial_schema.sql]
---

<objective>
Supabase 연동 및 DB 스키마 생성

Purpose: 데이터 저장소 구축 - 링크, 최애(bias), 태그를 위한 스키마 설계
Output: Supabase 연결 완료, 핵심 테이블 생성, TypeScript 타입 정의
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Core value reminder:** 링크 정리가 핵심. URL + 메타데이터 + 태그.
**Tech constraint:** Supabase 무료 티어 (500MB)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Supabase client and environment</name>
  <files>.env.local, src/lib/supabase.ts, package.json</files>
  <action>
Install Supabase client:
```
pnpm add @supabase/supabase-js
```

Create Supabase client in `src/lib/supabase.ts`:
```typescript
import { createClient } from '@supabase/supabase-js'
import type { Database } from '@/types/database'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey)
```

Create basic type placeholder in `src/types/database.ts`:
```typescript
// Generated types will be added after schema creation
// For now, minimal placeholder to allow client setup

export type Database = {
  public: {
    Tables: {
      // Will be populated after migration
    }
  }
}
```

Update `.env.local` with actual Supabase credentials:
- Use `supabase` CLI or Supabase dashboard to get URL and anon key
- If CLI not authenticated, prompt for manual entry of credentials

Note: Do NOT hardcode credentials. Always use environment variables.
  </action>
  <verify>
pnpm build passes (TypeScript compiles)
.env.local contains non-empty SUPABASE_URL and ANON_KEY values
  </verify>
  <done>
@supabase/supabase-js installed
Supabase client configured with types
Environment variables set
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema for core entities</name>
  <files>supabase/migrations/001_initial_schema.sql, src/types/database.ts</files>
  <action>
Create migration file `supabase/migrations/001_initial_schema.sql`:

```sql
-- 최애 (bias) 테이블 - 추적할 아이돌/멤버
CREATE TABLE biases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  group_name TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 링크 테이블 - 핵심 엔티티
CREATE TABLE links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL UNIQUE,
  title TEXT,
  description TEXT,
  thumbnail_url TEXT,
  platform TEXT, -- 'youtube', 'twitter', 'weverse', etc.
  original_date DATE, -- 콘텐츠 원본 날짜
  bias_id UUID REFERENCES biases(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 태그 테이블
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 링크-태그 다대다 관계
CREATE TABLE link_tags (
  link_id UUID REFERENCES links(id) ON DELETE CASCADE,
  tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
  PRIMARY KEY (link_id, tag_id)
);

-- 인덱스
CREATE INDEX idx_links_bias_id ON links(bias_id);
CREATE INDEX idx_links_platform ON links(platform);
CREATE INDEX idx_links_original_date ON links(original_date);
CREATE INDEX idx_link_tags_tag_id ON link_tags(tag_id);

-- updated_at 자동 업데이트 트리거
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER biases_updated_at
  BEFORE UPDATE ON biases
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER links_updated_at
  BEFORE UPDATE ON links
  FOR EACH ROW EXECUTE FUNCTION update_updated_at();
```

Apply migration using Supabase CLI:
```
supabase db push
```

Or if CLI not set up, run SQL directly in Supabase SQL Editor (dashboard).

After migration, update `src/types/database.ts` with proper types:
```typescript
export type Database = {
  public: {
    Tables: {
      biases: {
        Row: {
          id: string
          name: string
          group_name: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          name: string
          group_name?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          name?: string
          group_name?: string | null
          updated_at?: string
        }
      }
      links: {
        Row: {
          id: string
          url: string
          title: string | null
          description: string | null
          thumbnail_url: string | null
          platform: string | null
          original_date: string | null
          bias_id: string | null
          created_at: string
          updated_at: string
        }
        Insert: {
          id?: string
          url: string
          title?: string | null
          description?: string | null
          thumbnail_url?: string | null
          platform?: string | null
          original_date?: string | null
          bias_id?: string | null
          created_at?: string
          updated_at?: string
        }
        Update: {
          id?: string
          url?: string
          title?: string | null
          description?: string | null
          thumbnail_url?: string | null
          platform?: string | null
          original_date?: string | null
          bias_id?: string | null
          updated_at?: string
        }
      }
      tags: {
        Row: {
          id: string
          name: string
          created_at: string
        }
        Insert: {
          id?: string
          name: string
          created_at?: string
        }
        Update: {
          id?: string
          name?: string
        }
      }
      link_tags: {
        Row: {
          link_id: string
          tag_id: string
        }
        Insert: {
          link_id: string
          tag_id: string
        }
        Update: {
          link_id?: string
          tag_id?: string
        }
      }
    }
  }
}

// Convenience types
export type Bias = Database['public']['Tables']['biases']['Row']
export type Link = Database['public']['Tables']['links']['Row']
export type Tag = Database['public']['Tables']['tags']['Row']
export type LinkTag = Database['public']['Tables']['link_tags']['Row']
```
  </action>
  <verify>
supabase/migrations/001_initial_schema.sql exists
Tables created in Supabase (check dashboard or: supabase db diff shows no changes)
pnpm build passes with new types
  </verify>
  <done>
Migration file created
4 tables created: biases, links, tags, link_tags
TypeScript types defined and exported
Indexes and triggers in place
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds with no TypeScript errors
- [ ] Supabase client can be imported: `import { supabase } from '@/lib/supabase'`
- [ ] Database tables exist in Supabase dashboard
- [ ] Types are properly exported from `src/types/database.ts`
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Database schema matches the design
- TypeScript types accurately reflect schema
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
