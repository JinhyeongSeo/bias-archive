---
phase: 23-unified-search-ux-improvements
plan: 01-FIX
type: fix
---

<objective>
Fix 6 UAT issues from plan 23-01 (Unified Search UX Improvements).

Source: 23-01-ISSUES.md
Priority: 0 critical, 2 major, 3 minor, 1 cosmetic
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/23-unified-search-ux-improvements/23-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/23-unified-search-ux-improvements/23-01-PLAN.md

**Current implementation:**
@src/components/UnifiedSearch.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-002 - 언어 모드에 따른 그룹명 표시</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  Major 이슈: 그룹명이 항상 "한글명 영어명" 형식으로 표시/입력됨.

  **현재 문제 (line 241-258):**
  - 그룹 선택 시: `[group.name_ko, group.name_en].filter(Boolean).join(' ')`
  - 언어 모드 무시하고 항상 둘 다 표시

  **수정 방안:**
  1. 그룹 선택 시 `getDisplayName`과 유사하게 언어 모드에 따라 하나만 선택:
     - 한국어 모드: `group.name_ko || group.name`
     - 영어 모드: `group.name_en || group.name`
  2. `getSelectionDisplayName` 함수도 동일하게 수정 (line 178-193)
  3. 드롭다운 내 그룹 헤더 표시도 언어 모드 적용 (line 1653)
  4. `useNameLanguage` 훅에서 현재 언어 모드 가져와서 사용

  언어 모드에 따른 그룹명 선택 로직 추가.
  </action>
  <verify>npm run build 성공, 한국어/영어 모드 전환 시 그룹명 표시 확인</verify>
  <done>그룹명이 언어 모드에 따라 단일 언어로만 표시 및 검색어 입력</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-005 - 아이돌 검색 시 성 제거</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  Major 이슈: "장원영" 같은 전체 이름으로 검색하면 결과가 적음.

  **현재 문제 (line 251-256):**
  - `setQuery(selectedBias.name_ko || selectedBias.name)` - 전체 이름 사용

  **수정 방안:**
  한국 이름에서 성 제거하는 헬퍼 함수 추가:
  ```typescript
  const removeKoreanSurname = (name: string): string => {
    // 한글 이름이고 2-4글자인 경우 첫 글자(성) 제거
    if (/^[가-힣]{2,4}$/.test(name)) {
      return name.slice(1) // 예: "장원영" → "원영"
    }
    return name
  }
  ```

  한국어 이름 선택 시:
  - `name_ko`가 있으면: `removeKoreanSurname(name_ko)` 사용
  - `name`만 있으면: 한글이면 성 제거, 영어면 그대로

  영어 이름은 성 제거하지 않음 (검색에 유용할 수 있음).
  </action>
  <verify>npm run build 성공, 아이돌 선택 시 성 없는 이름으로 검색어 설정 확인</verify>
  <done>한국 아이돌 선택 시 성 제거된 이름으로 검색 (예: "원영")</done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-001 - 그룹 기본 접힌 상태로 시작</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  Minor 이슈: 드롭다운 열면 모든 그룹이 펼쳐진 상태.

  **현재 문제 (line 111):**
  - `collapsedDropdownGroups` 초기값이 빈 Set → 모든 그룹 펼쳐짐

  **수정 방안:**
  드롭다운 열릴 때 모든 그룹을 접힌 상태로 초기화:
  ```typescript
  // 드롭다운 열릴 때 모든 그룹 접기
  useEffect(() => {
    if (isIdolDropdownOpen) {
      const allGroupIds = new Set(
        biasesWithGroups
          .map(b => b.group_id)
          .filter((id): id is string => id !== null)
      )
      setCollapsedDropdownGroups(allGroupIds)
    }
  }, [isIdolDropdownOpen, biasesWithGroups])
  ```

  또는 로직 반전: `collapsedDropdownGroups` → `expandedDropdownGroups`로 변경하여
  기본이 접힌 상태가 되도록. 더 간단한 방법 선택.
  </action>
  <verify>npm run build 성공, 드롭다운 열 때 그룹이 접힌 상태인지 확인</verify>
  <done>드롭다운 열면 그룹이 기본 접힌 상태, 클릭으로 펼침</done>
</task>

<task type="auto">
  <name>Task 4: Fix UAT-003 - 그룹 순서 정렬</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  Minor 이슈: 아이돌 목록이 그룹 sort_order 순서대로 표시되지 않음.

  **현재 문제 (line 152-163):**
  - `groupedBiases` Map이 삽입 순서 유지하지만, 그룹 sort_order 고려 안함

  **수정 방안:**
  `groupedBiases` 생성 시 그룹 sort_order로 정렬:
  ```typescript
  const groupedBiases = useMemo(() => {
    const grouped = new Map<string | null, BiasWithGroup[]>()

    // 먼저 그룹을 sort_order로 정렬
    const sortedGroups = [...groups].sort((a, b) =>
      (a.sort_order ?? 0) - (b.sort_order ?? 0)
    )

    // 정렬된 그룹 순서대로 Map에 추가
    for (const group of sortedGroups) {
      const biasesInGroup = biasesWithGroups.filter(b => b.group_id === group.id)
      if (biasesInGroup.length > 0) {
        grouped.set(group.id, biasesInGroup)
      }
    }

    // 미분류 아이돌은 마지막에
    const ungrouped = biasesWithGroups.filter(b => !b.group_id)
    if (ungrouped.length > 0) {
      grouped.set(null, ungrouped)
    }

    return grouped
  }, [biasesWithGroups, groups])
  ```
  </action>
  <verify>npm run build 성공, 그룹이 sort_order 순서대로 표시되는지 확인</verify>
  <done>그룹이 사용자 설정 순서(sort_order)대로 표시</done>
</task>

<task type="auto">
  <name>Task 5: Fix UAT-004 - 멤버 들여쓰기 강화</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  Cosmetic 이슈: 그룹 멤버 이름 들여쓰기가 부족함.

  **현재 문제 (line 1660):**
  - `<div className="pl-4">` - 16px 들여쓰기만 적용

  **수정 방안:**
  들여쓰기 강화 및 시각적 구분 추가:
  - `pl-4` → `pl-6` 또는 `pl-8`로 증가 (24px 또는 32px)
  - 선택적으로 멤버 앞에 작은 점이나 대시 추가:
    ```tsx
    <span className="text-zinc-300 dark:text-zinc-600 mr-2">•</span>
    ```
  - 또는 border-left로 시각적 연결선 표시

  현재 레이아웃과 조화롭게 들여쓰기 수준 조정.
  </action>
  <verify>npm run build 성공, 멤버가 그룹 헤더와 시각적으로 구분되는지 확인</verify>
  <done>그룹 멤버에 적절한 들여쓰기 적용, 그룹 헤더와 명확히 구분</done>
</task>

<task type="auto">
  <name>Task 6: Fix UAT-006 - 드롭다운 overflow 처리</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  Minor 이슈: 드롭다운이 모달 경계에서 잘림.

  **현재 문제:**
  - 드롭다운이 absolute 위치로 모달 내에 렌더링
  - 모달의 overflow 설정에 의해 잘릴 수 있음

  **수정 방안 (옵션 중 택일):**

  **옵션 A: 드롭다운 위치 조정 (권장)**
  - 드롭다운이 위로 열리도록 하거나 (위아래 공간 계산)
  - max-height 줄여서 모달 내에서 스크롤

  **옵션 B: 모달 overflow 조정**
  - 드롭다운 컨테이너에 `overflow-visible` 적용
  - 모달 내용 영역의 overflow 설정 검토

  **옵션 C: Portal 사용**
  - 드롭다운을 document.body에 Portal로 렌더링
  - 위치 계산 필요 (복잡도 증가)

  가장 간단한 옵션 A 적용: max-h-64 → max-h-48로 줄이고,
  드롭다운이 모달 내에서 완전히 보이도록 함.
  </action>
  <verify>npm run build 성공, 드롭다운이 잘리지 않고 완전히 표시되는지 확인</verify>
  <done>드롭다운이 모달 경계 내에서 완전히 표시됨</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 6 UAT issues addressed
- [ ] `npm run build` 성공
- [ ] `npm run lint` 통과
- [ ] 언어 모드 전환 시 그룹명 올바르게 표시 (UAT-002)
- [ ] 아이돌 선택 시 성 제거된 이름으로 검색 (UAT-005)
- [ ] 그룹 기본 접힌 상태 (UAT-001)
- [ ] 그룹 sort_order 순서 적용 (UAT-003)
- [ ] 멤버 들여쓰기 충분 (UAT-004)
- [ ] 드롭다운 완전 표시 (UAT-006)
</verification>

<success_criteria>
- All UAT issues from 23-01-ISSUES.md addressed
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/23-unified-search-ux-improvements/23-01-FIX-SUMMARY.md`
</output>
