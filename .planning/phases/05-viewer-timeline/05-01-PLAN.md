---
phase: 05-viewer-timeline
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/002_link_media.sql, src/types/database.ts, src/lib/parsers/twitter.ts, src/lib/links.ts]
---

<objective>
다중 미디어 저장 기능 구현 - link_media 테이블로 Twitter 여러 이미지 지원

Purpose: STATE.md에서 deferred된 "Twitter 다중 이미지 저장" 이슈 해결
Output: link_media 테이블, 수정된 Twitter 파서, 다중 미디어 조회 API
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/database.ts
@src/lib/parsers/twitter.ts
@src/lib/links.ts
@supabase/migrations/001_initial_schema.sql

**Deferred issue from STATE.md:**
- Twitter 다중 이미지 저장 → Phase 5 link_media 테이블에서 처리

**Tech stack available:**
- Supabase, TypeScript, Next.js App Router

**Established patterns:**
- Migration files: supabase/migrations/
- Database types: src/types/database.ts
- Parser modules: src/lib/parsers/
</context>

<tasks>

<task type="auto">
  <name>Task 1: link_media 테이블 생성</name>
  <files>supabase/migrations/002_link_media.sql, src/types/database.ts</files>
  <action>
1. supabase/migrations/002_link_media.sql 생성:
   - link_media 테이블: id, link_id (FK), media_url, media_type ('image'|'video'|'gif'), position (순서), created_at
   - link_id에 ON DELETE CASCADE
   - position 인덱스 추가

2. src/types/database.ts 업데이트:
   - link_media 테이블 타입 추가
   - LinkMedia, LinkMediaInsert 타입 export
   - LinkWithMedia 타입 추가 (Link & { media: LinkMedia[] })
  </action>
  <verify>TypeScript 컴파일 에러 없음 (npm run build)</verify>
  <done>link_media 타입 정의 완료, migration SQL 파일 생성</done>
</task>

<task type="auto">
  <name>Task 2: Twitter 파서 다중 이미지 지원</name>
  <files>src/lib/parsers/twitter.ts, src/lib/links.ts, src/app/api/links/route.ts</files>
  <action>
1. src/lib/parsers/twitter.ts 수정:
   - ParsedMetadata 타입에 media?: { url: string, type: 'image'|'video'|'gif' }[] 추가
   - vxtwitter API 응답에서 media_extended 배열 파싱
   - 첫 번째 이미지는 기존 thumbnail_url로, 나머지는 media 배열로 반환

2. src/lib/links.ts 수정:
   - createLink() 함수에서 media 배열 받아서 link_media 테이블에 저장
   - getLinksWithTags()를 getLinksWithTagsAndMedia()로 확장 (media JOIN)

3. src/app/api/links/route.ts 수정:
   - POST: metadata.media 있으면 link_media에 저장
   - GET: media 포함해서 반환
  </action>
  <verify>
1. Twitter 다중 이미지 URL 저장 테스트
2. API 응답에 media 배열 포함 확인
  </verify>
  <done>Twitter 트윗의 모든 이미지가 link_media 테이블에 저장됨</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build 성공
- [ ] TypeScript 에러 없음
- [ ] Twitter 다중 이미지 URL이 link_media 테이블에 저장됨
- [ ] GET /api/links 응답에 media 배열 포함
</verification>

<success_criteria>
- link_media 테이블 타입 정의 완료
- Twitter 파서가 여러 이미지 반환
- 링크 저장 시 media 배열도 저장
- 링크 조회 시 media 포함
</success_criteria>

<output>
After completion, create `.planning/phases/05-viewer-timeline/05-01-SUMMARY.md`
</output>
