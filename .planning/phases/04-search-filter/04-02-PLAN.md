---
phase: 04-search-filter
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [src/lib/search.ts, src/app/api/search/route.ts, src/components/ExternalSearch.tsx, src/components/Sidebar.tsx]
---

<objective>
통합 외부 검색 기능 구현 (YouTube + Twitter)

Purpose: 앱 내에서 YouTube/Twitter 직캠을 검색하고 바로 저장 (URL 복사 불필요)
Output: 통합 검색 UI, 플랫폼별 결과 미리보기, 선택 저장 기능
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-search-filter/DISCOVERY.md

# Discovery 핵심 정보
- Google Custom Search API: 100회/일 무료
- site:twitter.com + site:youtube.com 검색 가능
- 검색 결과 링크 → 기존 메타데이터 추출 API 활용

# 기존 코드 참조 (재사용)
@src/lib/metadata.ts - extractMetadata() 함수
@src/lib/parsers/twitter.ts - vxtwitter API (썸네일, 제목, 미디어)
@src/lib/parsers/youtube.ts - YouTube oEmbed (썸네일, 제목)
@src/app/api/links/route.ts - POST 저장 패턴
</context>

<tasks>

<task type="auto">
  <name>Task 1: Google Custom Search API 라우트 생성</name>
  <files>src/lib/search.ts, src/app/api/search/route.ts</files>
  <action>
  1. src/lib/search.ts 생성:
     - searchExternal(query: string, platform: 'youtube' | 'twitter' | 'all') 함수
     - Google Custom Search API 호출
     - platform에 따라 site: 연산자 추가:
       - youtube: "site:youtube.com {query}"
       - twitter: "site:twitter.com {query}"
       - all: "{query}" (전체)
     - 반환: { link, title, snippet }[] (Google 결과 그대로)

  2. src/app/api/search/route.ts 생성:
     - GET /api/search?q={query}&platform={youtube|twitter|all}
     - 환경변수 확인: GOOGLE_CSE_API_KEY, GOOGLE_CSE_ID
     - 없으면 501 반환 (설정 안내 메시지)

  Google Custom Search API 엔드포인트:
  GET https://www.googleapis.com/customsearch/v1
    ?key={GOOGLE_CSE_API_KEY}
    &cx={GOOGLE_CSE_ID}
    &q={site:xxx.com query}
    &num=10

  주의: API 키 클라이언트 노출 금지 - 서버에서만 처리
  </action>
  <verify>
  1. 환경변수 없이 테스트:
     curl 'http://localhost:3000/api/search?q=test&platform=youtube' → 501 응답
  2. 환경변수 설정 후:
     curl 'http://localhost:3000/api/search?q=카리나 직캠&platform=twitter' → 검색 결과
  </verify>
  <done>
  - /api/search API 작동
  - platform 파라미터로 YouTube/Twitter 필터링
  - API 키 미설정 시 적절한 에러
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Google Custom Search API 설정</action>
  <instructions>
  통합 검색 기능을 사용하려면 Google Custom Search 설정이 필요합니다.

  1. Google Cloud Console: https://console.cloud.google.com/
     - 프로젝트 생성/선택
     - "Custom Search API" 활성화
     - Credentials에서 API 키 생성

  2. Programmable Search Engine: https://programmablesearchengine.google.com/
     - 새 검색 엔진 생성
     - "전체 웹 검색" 옵션 선택
     - Search Engine ID (cx) 복사

  3. .env.local에 추가:
     ```
     GOOGLE_CSE_API_KEY=your_api_key
     GOOGLE_CSE_ID=your_cx_id
     ```

  (이미 설정되어 있다면 "skip" 입력)
  </instructions>
  <verification>curl 테스트로 API 작동 확인</verification>
  <resume-signal>설정 완료 후 "done" 또는 이미 있으면 "skip" 입력</resume-signal>
</task>

<task type="auto">
  <name>Task 2: 통합 검색 UI 및 메타데이터 미리보기</name>
  <files>src/components/ExternalSearch.tsx, src/components/Sidebar.tsx</files>
  <action>
  1. src/components/ExternalSearch.tsx 생성:
     - 검색 입력 + 플랫폼 선택 (YouTube / Twitter / 전체)
     - 검색 버튼 클릭 시:
       a. /api/search 호출 → 링크 목록 받음
       b. 각 링크에 대해 /api/metadata 호출 → 썸네일, 제목 등 받음
       c. 결과 카드로 표시

     - 결과 카드 UI:
       - 썸네일 (120x90)
       - 제목 (1-2줄)
       - 작성자/채널명
       - 플랫폼 뱃지 (YouTube/Twitter)
       - "저장" 버튼

     - 저장 버튼 클릭:
       - /api/links POST 호출
       - 성공 시 체크 표시로 변경
       - refreshTrigger 증가

     - 상태 관리:
       - 검색 중 로딩 스피너
       - 메타데이터 로딩 중 스켈레톤
       - 에러 시 토스트/메시지

  2. src/components/Sidebar.tsx 수정:
     - "외부 검색" 섹션 추가 (태그 섹션 아래)
     - 토글 버튼으로 ExternalSearch 펼침/접힘
     - 또는 모달로 구현 (사이드바 공간 부족 시)

  성능 최적화:
  - 메타데이터 요청은 병렬 처리 (Promise.all)
  - 최대 10개 결과만 미리보기
  - 실패한 메타데이터는 제목/링크만 표시
  </action>
  <verify>
  npm run dev 후:
  1. 사이드바에서 외부 검색 UI 확인
  2. "카리나 직캠" 검색 → YouTube/Twitter 결과 표시
  3. 결과에 썸네일, 제목, 작성자 표시 확인
  4. "저장" 클릭 → 메인 목록에 추가 확인
  5. 플랫폼 전환 (YouTube ↔ Twitter) 작동 확인
  </verify>
  <done>
  - 통합 검색 UI 작동
  - YouTube 검색 시 썸네일/제목 표시
  - Twitter 검색 시 썸네일/제목 표시 (vxtwitter)
  - 저장 후 목록 자동 갱신
  - 플랫폼 필터 전환 작동
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build 성공
- [ ] npm run lint 통과
- [ ] YouTube 검색 결과 표시 (썸네일 포함)
- [ ] Twitter 검색 결과 표시 (썸네일 포함)
- [ ] 결과에서 저장 클릭 시 링크 추가
- [ ] 저장 후 메인 목록 갱신
- [ ] API 키 미설정 시 적절한 안내
</verification>

<success_criteria>

- 모든 tasks 완료
- 검증 항목 모두 통과
- YouTube + Twitter 통합 검색으로 URL 복사 없이 직캠 저장 가능
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-filter/04-02-SUMMARY.md`
</output>
