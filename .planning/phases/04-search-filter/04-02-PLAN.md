---
phase: 04-search-filter
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [src/lib/youtube.ts, src/lib/search.ts, src/app/api/youtube/search/route.ts, src/app/api/search/twitter/route.ts, src/components/ExternalSearch.tsx, src/components/Sidebar.tsx]
---

<objective>
통합 외부 검색 기능 구현 (YouTube 실시간 + Twitter 과거 인기)

Purpose: 앱 내에서 YouTube/Twitter 직캠을 검색하고 바로 저장 (URL 복사 불필요)
Output: 통합 검색 UI, 플랫폼별 결과 미리보기, 이미 저장된 링크 표시, 선택 저장 기능

Note:
- YouTube: 실시간 검색 (YouTube Data API)
- Twitter: 과거 인기 트윗 검색 (Google 인덱싱 기반, 최신 트윗은 URL 직접 입력 안내)
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-search-filter/DISCOVERY.md

# Discovery 핵심 정보
- YouTube: YouTube Data API (site: 필터 불안정하여 전용 API 사용)
- Twitter: Google CSE site:twitter.com + vxtwitter 메타데이터

# 기존 코드 참조 (재사용)
@src/lib/metadata.ts - extractMetadata() 함수
@src/lib/parsers/twitter.ts - vxtwitter API (썸네일, 제목, 미디어)
@src/lib/parsers/youtube.ts - YouTube oEmbed (썸네일, 제목)
@src/lib/links.ts - checkDuplicateUrl() 함수 (중복 체크)
@src/app/api/links/route.ts - POST 저장 패턴
</context>

<tasks>

<task type="auto">
  <name>Task 1: YouTube Data API + Twitter Google CSE 라우트 생성</name>
  <files>src/lib/youtube.ts, src/lib/search.ts, src/app/api/youtube/search/route.ts, src/app/api/search/twitter/route.ts</files>
  <action>
  1. src/lib/youtube.ts 생성:
     - searchYouTube(query: string, maxResults?: number) 함수
     - YouTube Data API v3 search.list 호출
     - 반환: { videoId, title, thumbnailUrl, channelTitle, publishedAt }[]

  2. src/app/api/youtube/search/route.ts 생성:
     - GET /api/youtube/search?q={query}&max={number}
     - 환경변수: YOUTUBE_API_KEY
     - 없으면 501 반환

  3. src/lib/search.ts 생성:
     - searchTwitter(query: string) 함수
     - Google Custom Search API + site:twitter.com
     - 반환: { link, title, snippet }[]

  4. src/app/api/search/twitter/route.ts 생성:
     - GET /api/search/twitter?q={query}
     - 환경변수: GOOGLE_CSE_API_KEY, GOOGLE_CSE_ID
     - 없으면 501 반환

  YouTube API:
  GET https://www.googleapis.com/youtube/v3/search
    ?part=snippet&type=video&q={query}&key={YOUTUBE_API_KEY}

  Google CSE API:
  GET https://www.googleapis.com/customsearch/v1
    ?key={GOOGLE_CSE_API_KEY}&cx={GOOGLE_CSE_ID}&q=site:twitter.com {query}
  </action>
  <verify>
  curl 'http://localhost:3000/api/youtube/search?q=카리나' → YouTube 결과
  curl 'http://localhost:3000/api/search/twitter?q=카리나' → Twitter 링크 목록
  </verify>
  <done>
  - YouTube 검색 API 작동
  - Twitter 검색 API 작동 (Google CSE)
  - API 키 미설정 시 501 에러
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>API 키 설정 (YouTube + Google CSE)</action>
  <instructions>
  외부 검색 기능을 위해 API 키 설정이 필요합니다.

  **YouTube Data API:**
  1. Google Cloud Console → APIs & Services → Library
  2. "YouTube Data API v3" 활성화
  3. Credentials에서 API 키 생성

  **Google Custom Search (Twitter용):**
  1. Google Cloud Console → "Custom Search API" 활성화
  2. https://programmablesearchengine.google.com/ 에서 검색 엔진 생성
  3. "전체 웹 검색" 옵션 선택
  4. Search Engine ID (cx) 복사

  **.env.local에 추가:**
  ```
  YOUTUBE_API_KEY=your_youtube_key
  GOOGLE_CSE_API_KEY=your_cse_key
  GOOGLE_CSE_ID=your_cx_id
  ```

  (이미 설정되어 있다면 "skip" 입력)
  </instructions>
  <verification>curl 테스트로 API 작동 확인</verification>
  <resume-signal>설정 완료 후 "done" 또는 이미 있으면 "skip" 입력</resume-signal>
</task>

<task type="auto">
  <name>Task 2: 통합 검색 UI (이미 저장된 링크 표시 포함)</name>
  <files>src/components/ExternalSearch.tsx, src/components/Sidebar.tsx</files>
  <action>
  1. src/components/ExternalSearch.tsx 생성:
     - 검색 입력 + 플랫폼 선택 (YouTube / Twitter)
     - Twitter 선택 시 "과거 인기 트윗 검색 (최신은 URL 직접 입력)" 안내 표시
     - 검색 시:
       a. YouTube: /api/youtube/search → 바로 결과 표시 (메타데이터 포함)
       b. Twitter: /api/search/twitter → 링크 목록 → /api/metadata로 메타데이터 추출

     - **이미 저장된 링크 체크:**
       - 검색 결과 받은 후, 각 URL에 대해 DB 중복 체크
       - 방법 1: 클라이언트에서 현재 링크 목록과 비교
       - 방법 2: /api/links/check?url={url} API 호출
       - 이미 저장된 링크는 "저장됨" 뱃지 표시 + 저장 버튼 비활성화

     - 결과 카드 UI:
       - 썸네일 (120x90)
       - 제목 (1-2줄)
       - 작성자/채널명
       - 플랫폼 뱃지 (YouTube/Twitter)
       - "저장" 버튼 또는 "저장됨" 뱃지

     - 저장 버튼 클릭:
       - /api/links POST 호출
       - 성공 시 해당 항목 "저장됨"으로 변경
       - refreshTrigger 증가

  2. src/components/Sidebar.tsx 수정:
     - "외부 검색" 섹션 추가
     - 토글 버튼으로 ExternalSearch 펼침/접힘

  **중복 체크 최적화:**
  - 검색 시 현재 저장된 URL 목록을 props로 전달받거나
  - 한 번에 여러 URL 체크하는 배치 API 구현 (/api/links/check-batch)
  </action>
  <verify>
  npm run dev 후:
  1. YouTube 검색 → 결과 표시
  2. Twitter 검색 → 결과 표시 (vxtwitter 메타데이터)
  3. "저장" 클릭 → 메인 목록에 추가
  4. 같은 검색 다시 → 저장한 항목 "저장됨" 표시 확인
  5. 이미 저장된 링크 검색 → "저장됨" 뱃지 확인
  </verify>
  <done>
  - YouTube/Twitter 검색 UI 작동
  - 이미 저장된 링크는 "저장됨" 표시
  - 저장 버튼 클릭 시 즉시 "저장됨"으로 변경
  - 중복 저장 방지
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build 성공
- [ ] npm run lint 통과
- [ ] YouTube 검색 결과 표시 (썸네일 포함)
- [ ] Twitter 검색 결과 표시 (썸네일 포함)
- [ ] 이미 저장된 링크 "저장됨" 표시
- [ ] 저장 후 해당 항목 "저장됨"으로 변경
- [ ] 저장 후 메인 목록 갱신
- [ ] API 키 미설정 시 적절한 안내
</verification>

<success_criteria>

- 모든 tasks 완료
- 검증 항목 모두 통과
- YouTube + Twitter 통합 검색으로 URL 복사 없이 직캠 저장 가능
- 이미 저장된 링크 명확히 구분
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-filter/04-02-SUMMARY.md`
</output>
