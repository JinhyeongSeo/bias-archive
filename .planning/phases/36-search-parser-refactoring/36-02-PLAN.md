---
phase: 36-search-parser-refactoring
plan: 02
type: execute
depends_on: ["36-01"]
files_modified:
  - src/app/api/search/instagram/route.ts
  - src/components/ExternalSearch.tsx
  - src/lib/searchCache.ts
---

<objective>
Instagram 검색 API 버그 수정 및 검증

Purpose: Instagram 검색 기능이 제대로 동작하도록 Apify Actor API 파라미터 검증 및 수정
Output: 정상 작동하는 Instagram 해시태그 검색 기능
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-search-parser-refactoring/36-01-SUMMARY.md

**관련 파일:**
@src/app/api/search/instagram/route.ts
@src/components/ExternalSearch.tsx
@src/lib/searchCache.ts

**발견된 문제점:**
1. Apify Actor API 파라미터가 잘못되었을 수 있음 (resultsType, resultsLimit 등)
2. 검색 결과가 제대로 표시되지 않음
3. 미디어 데이터 연동 문제 (ReelsViewer와의 호환성)

**Apify Instagram Hashtag Scraper 참고:**
- Actor ID: apify/instagram-hashtag-scraper
- 입력: hashtags 배열, resultsLimit 숫자
- 출력: id, shortCode, url, caption, displayUrl, videoUrl, ownerUsername, type 등
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apify Actor API 파라미터 검증 및 수정</name>
  <files>src/app/api/search/instagram/route.ts</files>
  <action>
1. Apify Actor 호출 파라미터 확인:
   - `hashtags`: 문자열 배열 (정상)
   - `resultsLimit`: 숫자 (정상)
   - `resultsType` 파라미터 제거 (공식 API에 없을 수 있음)

2. 응답 필드 매핑 검증:
   - item.url 또는 shortCode로 URL 생성
   - item.displayUrl로 썸네일
   - item.videoUrl로 비디오 (있을 경우)
   - item.type으로 미디어 타입 판별 ('Image', 'Video', 'Sidecar')

3. 에러 처리 개선:
   - Apify 응답이 비어있을 때 빈 배열 반환
   - rate limit 에러 처리
  </action>
  <verify>
APIFY_API_TOKEN이 설정된 환경에서:
curl "http://localhost:3000/api/search/instagram?q=아이돌&limit=5"
응답에 results 배열과 hasMore 필드 확인
  </verify>
  <done>Apify Actor API 정상 호출, 응답 매핑 완료</done>
</task>

<task type="auto">
  <name>Task 2: Instagram 검색 결과 미디어 데이터 수정</name>
  <files>src/app/api/search/instagram/route.ts</files>
  <action>
1. 검색 결과의 media 배열이 ExternalSearch와 호환되도록 수정:
   - type: 'image' | 'video' (소문자)
   - url: 디코딩된 URL

2. Sidecar(캐러셀) 게시물 처리 개선:
   - childPosts가 있으면 모든 미디어 추출
   - childPosts가 없으면 displayUrl/videoUrl 사용

3. 미디어 URL 디코딩 확인 (decodeHtmlEntities 적용)
  </action>
  <verify>
검색 결과에서 media 배열이 정상적으로 반환되는지 확인
캐러셀 게시물에서 여러 이미지가 표시되는지 확인
  </verify>
  <done>미디어 데이터가 ExternalSearch 및 ReelsViewer와 호환</done>
</task>

<task type="auto">
  <name>Task 3: ExternalSearch Instagram 탭 동작 검증</name>
  <files>src/components/ExternalSearch.tsx</files>
  <action>
1. Instagram 탭에서 검색 결과가 정상 표시되는지 확인
2. 썸네일 이미지 로딩 확인
3. 검색 결과 선택 및 저장 기능 확인
4. 필요시 Instagram 특화 처리 추가 (예: 캐러셀 미디어 개수 표시)

참고: ExternalSearch에서 Instagram 결과 처리 시:
- result.thumbnailUrl로 썸네일 표시
- result.media 배열로 미디어 정보 전달
  </action>
  <verify>
npm run dev 실행 후:
1. 통합검색에서 Instagram 탭 선택
2. 해시태그 검색 (예: "아이돌", "kpop")
3. 결과 표시 및 선택 기능 정상 작동 확인
  </verify>
  <done>Instagram 검색 및 저장 기능 정상 작동</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] Instagram 검색 API 정상 응답 (APIFY_API_TOKEN 설정 시)
- [ ] 검색 결과 썸네일 표시
- [ ] 캐러셀 게시물 미디어 정상 추출
</verification>

<success_criteria>

- Apify Actor API 정상 호출
- 검색 결과 미디어 데이터 ExternalSearch 호환
- Instagram 탭에서 검색/선택/저장 정상 작동
- 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/36-search-parser-refactoring/36-02-SUMMARY.md`
</output>
