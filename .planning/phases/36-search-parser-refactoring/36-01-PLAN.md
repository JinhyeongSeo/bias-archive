---
phase: 36-search-parser-refactoring
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/utils/decodeHtmlEntities.ts
  - src/lib/parsers/instagram.ts
  - src/app/api/search/instagram/route.ts
  - src/lib/parsers/types.ts
  - src/components/ExternalSearch.tsx
---

<objective>
중복 코드 제거 및 미디어 타입 표준화

Purpose: Instagram 추가 후 꼬인 코드를 정리하고 일관성 있는 타입 시스템을 구축
Output: 공유 유틸리티 함수, 통일된 미디어 타입, 중복 코드 제거
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**관련 파일:**
@src/lib/parsers/instagram.ts
@src/app/api/search/instagram/route.ts
@src/lib/parsers/twitter.ts
@src/lib/parsers/heye.ts
@src/components/ExternalSearch.tsx

**발견된 문제점:**
1. `decodeHtmlEntities` 함수가 instagram.ts와 instagram/route.ts에 중복 (서로 다른 기능)
2. 미디어 타입이 파서마다 다르게 정의됨
3. undefined vs 빈 배열 반환 불일치
</context>

<tasks>

<task type="auto">
  <name>Task 1: 공유 decodeHtmlEntities 유틸리티 생성</name>
  <files>src/lib/utils/decodeHtmlEntities.ts</files>
  <action>
검색 API의 더 포괄적인 버전을 기반으로 공유 유틸리티 생성:
- named entities (&amp;, &lt;, &gt;, &quot;, &#039;, &apos;, &nbsp; 등)
- hex entities (&#xHHHH;)
- decimal entities (&#DDDD;)
모든 경우를 처리하는 단일 함수 export
  </action>
  <verify>
TypeScript 컴파일 성공, 테스트 케이스:
- decodeHtmlEntities('&amp;') === '&'
- decodeHtmlEntities('&#xd55c;&#xae00;') === '한글'
- decodeHtmlEntities('&#54620;&#44544;') === '한글'
  </verify>
  <done>src/lib/utils/decodeHtmlEntities.ts 파일 생성, export 확인</done>
</task>

<task type="auto">
  <name>Task 2: Instagram 파서 및 검색 API에서 중복 함수 제거</name>
  <files>src/lib/parsers/instagram.ts, src/app/api/search/instagram/route.ts</files>
  <action>
1. instagram.ts에서 decodeHtmlEntities 로컬 정의 제거, @/lib/utils/decodeHtmlEntities에서 import
2. instagram/route.ts에서 decodeHtmlEntities 로컬 정의 제거, @/lib/utils/decodeHtmlEntities에서 import
3. 두 파일 모두 동일한 공유 함수 사용 확인
  </action>
  <verify>
grep -r "function decodeHtmlEntities" src/ 결과 없음 (로컬 정의 제거됨)
npm run build 성공
  </verify>
  <done>중복 함수 제거, 공유 유틸리티로 대체</done>
</task>

<task type="auto">
  <name>Task 3: 미디어 타입 표준화 (ParsedMedia 타입 통일)</name>
  <files>src/lib/parsers/types.ts, src/lib/parsers/instagram.ts, src/app/api/search/instagram/route.ts, src/components/ExternalSearch.tsx</files>
  <action>
1. src/lib/parsers/types.ts에 표준 ParsedMedia 타입 정의 (이미 있으면 확인):
   ```typescript
   export interface ParsedMedia {
     type: 'image' | 'video' | 'gif';
     url: string;
   }
   ```
2. 모든 파서와 검색 API에서 이 타입 사용
3. media 필드 반환 일관성: 미디어 없으면 빈 배열 [] 반환 (undefined 대신)
4. ExternalSearch에서 타입 import 확인
  </action>
  <verify>
npm run build 성공
grep "media: undefined" src/ 결과 없음 (빈 배열로 통일)
  </verify>
  <done>모든 파서와 검색 API에서 ParsedMedia[] 타입 사용, 빈 배열 반환 통일</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] `npm run lint` 에러 없음
- [ ] decodeHtmlEntities 함수 중복 없음 (grep 확인)
- [ ] 미디어 타입 일관성 확인
</verification>

<success_criteria>

- 공유 유틸리티 src/lib/utils/decodeHtmlEntities.ts 생성
- Instagram 파서와 검색 API에서 중복 함수 제거
- ParsedMedia 타입 통일
- 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/36-search-parser-refactoring/36-01-SUMMARY.md`
</output>
