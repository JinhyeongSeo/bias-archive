---
phase: 34-internet-archive-backup
plan: 04-FIX
type: fix
---

<objective>
Simplify archive system: save original page URL instead of individual media URLs.

Source: .planning/todos/pending/2026-01-19-heye-cloudflare-block-archive.md
Problem: Internet Archive cannot fetch heye.kr media URLs due to Cloudflare blocking.
Solution: Archive the original page, not individual media files.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issue details:**
@.planning/todos/pending/2026-01-19-heye-cloudflare-block-archive.md

**Affected files:**
@src/lib/archive.ts
@src/app/api/links/[id]/archive/route.ts
@src/app/api/archive/process/route.ts
@src/components/LinkCard.tsx
</context>

<background>
## 현재 방식의 문제

현재: 미디어 URL 각각을 archive.org에 저장 시도
```
thumbnail_url → archive.org/save (Cloudflare 차단 가능)
link_media[0].media_url → archive.org/save (Cloudflare 차단 가능)
link_media[1].media_url → archive.org/save (Cloudflare 차단 가능)
...
```

문제점:
- 미디어 서버(img-heye.sblinker.com)가 Cloudflare로 보호됨
- archive.org 크롤러가 봇으로 감지되어 차단
- 미디어 개수만큼 API 호출 필요 (rate limit 4.5초 × N)

## 새로운 방식

원본 페이지 URL 하나만 저장:
```
link.url (원본 게시글) → archive.org/save
```

장점:
- 페이지는 Cloudflare 차단 가능성 낮음
- archive.org가 페이지 내 모든 리소스(이미지, 영상) 자동 저장
- API 호출 1회로 단순화
- 폴백 시 archive.org 페이지에서 미디어 로드 (기존 파서 로직 활용 가능)

## DB 스키마 변경

삭제:
- links.archived_thumbnail_url (불필요)
- link_media.archived_url (불필요)

유지:
- links.archived_url (원본 페이지의 archive.org URL)
- links.archive_status
- links.archived_at
</background>

<tasks>
<task type="auto">
  <name>Task 1: archive.ts 단순화</name>
  <files>src/lib/archive.ts</files>
  <action>
1. saveToArchive 함수는 그대로 유지 (URL 하나 저장하는 기능)

2. 새 함수 추가 - archivePageUrl:
   - 페이지 URL을 받아서 저장
   - 기존 saveToArchive 래핑
   - 반환값: archive_url (성공 시) 또는 null

3. 불필요한 복잡성 제거:
   - 개별 미디어 URL 처리 로직 없음
   - 단순히 페이지 URL 하나만 저장
  </action>
  <verify>TypeScript 컴파일 에러 없음</verify>
  <done>archive.ts가 페이지 URL 하나만 저장하는 단순한 구조로 변경됨</done>
</task>

<task type="auto">
  <name>Task 2: API 라우트 단순화</name>
  <files>src/app/api/links/[id]/archive/route.ts, src/app/api/archive/process/route.ts</files>
  <action>
1. /api/links/[id]/archive/route.ts 수정:
   - archiveMediaUrl 함수 제거
   - link.url (원본 페이지)을 saveToArchive로 저장
   - 결과를 links.archived_url에 저장
   - archived_thumbnail_url 관련 코드 제거
   - link_media 아카이브 루프 제거
   - delay 제거 (API 호출 1회만)

2. /api/archive/process/route.ts 수정:
   - 동일하게 단순화
   - 각 링크당 API 호출 1회
   - DELAY_BETWEEN_REQUESTS는 링크 간 간격으로만 사용

3. 응답 형식 단순화:
   ```json
   {
     "status": "archived",
     "archived_url": "https://web.archive.org/web/20260119/https://heye.kr/...",
     "archived_at": "2026-01-19T..."
   }
   ```
  </action>
  <verify>npm run build 성공</verify>
  <done>API가 원본 페이지 URL 하나만 저장하고, 응답이 단순화됨</done>
</task>

<task type="auto">
  <name>Task 3: DB 마이그레이션 - 불필요한 컬럼 제거</name>
  <files>supabase/migrations/new_migration.sql</files>
  <action>
1. 새 마이그레이션 파일 생성:
   - links.archived_thumbnail_url 컬럼 DROP
   - link_media.archived_url 컬럼 DROP

2. links.archived_url은 유지 (이미 존재하면 그대로, 없으면 확인)

3. 마이그레이션 파일 이름: YYYYMMDDHHMMSS_simplify_archive_columns.sql

주의: 기존 데이터 손실 가능하나, 아직 프로덕션에서 archive 기능 미사용이므로 괜찮음
  </action>
  <verify>npx supabase db push 성공 또는 마이그레이션 파일 검토</verify>
  <done>불필요한 archived_thumbnail_url, link_media.archived_url 컬럼 제거됨</done>
</task>

<task type="auto">
  <name>Task 4: UI 폴백 로직 수정</name>
  <files>src/components/LinkCard.tsx</files>
  <action>
1. 기존 폴백 로직 수정:
   - 이미지 onError 시 archived_thumbnail_url로 교체 → 제거

2. 새 폴백 로직:
   - 원본 이미지 로드 실패 시, "원본 페이지 보기" 또는 "아카이브에서 보기" 버튼 표시
   - archived_url이 있으면 archive.org 페이지로 이동하는 링크 제공

3. 아카이브 상태 표시:
   - archived_url 존재 시 아카이브 아이콘 표시
   - 클릭 시 archive.org 페이지 새 탭에서 열기
  </action>
  <verify>npm run dev로 UI 동작 확인</verify>
  <done>이미지 로드 실패 시 archive.org 페이지로 이동하는 폴백 UI 제공</done>
</task>

<task type="auto">
  <name>Task 5: TypeScript 타입 정리</name>
  <files>src/types/supabase.ts 또는 관련 타입 파일</files>
  <action>
1. Link 타입에서 archived_thumbnail_url 제거 (DB 컬럼 삭제 반영)
2. LinkMedia 타입에서 archived_url 제거
3. 관련 컴포넌트에서 타입 에러 수정

참고: Supabase 자동 생성 타입이면 `npx supabase gen types typescript` 실행
  </action>
  <verify>npm run build 성공, 타입 에러 없음</verify>
  <done>TypeScript 타입이 새 DB 스키마와 일치함</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build 성공
- [ ] 아카이브 요청 시 원본 페이지 URL이 archive.org에 저장됨
- [ ] API 호출이 링크당 1회로 단순화됨
- [ ] UI에서 archived_url로 archive.org 페이지 접근 가능
- [ ] 불필요한 컬럼(archived_thumbnail_url, link_media.archived_url) 제거됨
</verification>

<success_criteria>
- 아카이브 시스템이 원본 페이지 URL 하나만 저장하는 방식으로 단순화
- Cloudflare 차단 문제 우회 (페이지는 미디어보다 차단 가능성 낮음)
- API 호출 횟수 대폭 감소 (미디어 개수 → 1회)
- 폴백 시 archive.org 페이지에서 미디어 확인 가능
</success_criteria>

<output>
After completion, create `.planning/phases/34-internet-archive-backup/34-04-FIX-SUMMARY.md`
Move .planning/todos/pending/2026-01-19-heye-cloudflare-block-archive.md to .planning/todos/done/
</output>
