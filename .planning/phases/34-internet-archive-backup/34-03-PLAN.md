---
phase: 34-internet-archive-backup
plan: 03
type: execute
depends_on: ["34-02"]
files_modified: [src/components/LinkCard.tsx, src/components/ArchiveStatus.tsx, src/lib/proxy.ts]
---

<objective>
아카이브 상태 UI 표시 및 이미지/비디오 폴백 시스템 구현.

Purpose: 사용자에게 아카이브 상태를 시각적으로 보여주고, 원본 미디어 깨짐 시 Wayback으로 폴백.
Output: ArchiveStatus 컴포넌트, 수동 아카이브 버튼, 이미지/비디오 폴백 로직.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-internet-archive-backup/DISCOVERY.md
@.planning/phases/34-internet-archive-backup/34-02-SUMMARY.md
@src/components/LinkCard.tsx
@src/lib/proxy.ts

**Constraining decisions:**
- 폴백은 클라이언트 사이드 (onError 핸들러)
- Wayback URL 패턴: https://web.archive.org/web/{timestamp}/{originalUrl}
- 아이콘: Archive (보관함), CheckCircle (완료), Clock (대기), XCircle (실패)
</context>

<tasks>

<task type="auto">
  <name>Task 1: ArchiveStatus 컴포넌트 생성</name>
  <files>src/components/ArchiveStatus.tsx</files>
  <action>
src/components/ArchiveStatus.tsx 생성:

Props:
- status: 'pending' | 'archived' | 'failed' | null
- archiveUrl?: string | null
- onArchive?: () => void (수동 아카이브 트리거)
- isArchiving?: boolean (로딩 상태)
- size?: 'sm' | 'md' (기본 'sm')

UI:
1. status === null:
   - 아카이브 아이콘 버튼 (Archive from lucide-react)
   - 클릭 시 onArchive 호출
   - 툴팁: "Archive to Wayback Machine"

2. status === 'pending':
   - Clock 아이콘 (animate-spin)
   - 색상: text-yellow-500
   - 툴팁: "Archiving..."

3. status === 'archived':
   - CheckCircle 아이콘
   - 색상: text-green-500
   - 클릭 시 archiveUrl 새 탭에서 열기
   - 툴팁: "View archived version"

4. status === 'failed':
   - XCircle 아이콘
   - 색상: text-red-500
   - 클릭 시 onArchive 호출 (재시도)
   - 툴팁: "Archive failed - Click to retry"

5. isArchiving === true:
   - Loader2 아이콘 (animate-spin)
   - 버튼 비활성화

스타일:
- 작은 아이콘 버튼 (p-1, rounded)
- 호버 시 배경색 변경
- framer-motion으로 부드러운 전환
  </action>
  <verify>TypeScript 컴파일 성공, 컴포넌트 렌더링 확인</verify>
  <done>ArchiveStatus 컴포넌트 생성, 4가지 상태 표시 및 수동 아카이브 버튼 구현</done>
</task>

<task type="auto">
  <name>Task 2: LinkCard에 ArchiveStatus 통합</name>
  <files>src/components/LinkCard.tsx</files>
  <action>
src/components/LinkCard.tsx 수정:

1. ArchiveStatus 컴포넌트 import

2. 카드 헤더/액션 영역에 ArchiveStatus 추가:
   - starred 아이콘 옆에 배치
   - link.archive_status, link.archive_url 전달
   - onArchive 핸들러: POST /api/links/[id]/archive 호출
   - isArchiving 상태 관리 (useState)

3. onArchive 핸들러:
   - fetch('/api/links/${link.id}/archive', { method: 'POST' })
   - 성공 시 link 상태 업데이트 (archive_status, archive_url)
   - 실패 시 에러 토스트 표시

4. 환경 변수 체크:
   - NEXT_PUBLIC_ARCHIVE_ENABLED 환경 변수로 UI 표시 제어
   - 또는 서버에서 501 반환 시 UI 숨김

주의:
- 모바일에서도 터치 가능한 크기
- 기존 UI 레이아웃 유지
  </action>
  <verify>LinkCard에 ArchiveStatus 표시됨, 클릭 시 API 호출됨</verify>
  <done>LinkCard에 아카이브 상태 아이콘 및 수동 버튼 통합됨</done>
</task>

<task type="auto">
  <name>Task 3: 이미지/비디오 폴백 로직 구현</name>
  <files>src/lib/proxy.ts, src/components/LinkCard.tsx</files>
  <action>
1. src/lib/proxy.ts에 함수 추가:

getWaybackFallbackUrl(originalUrl: string, archiveUrl?: string | null): string | null
- archiveUrl이 있으면 그대로 반환
- 없으면 null 반환 (폴백 불가)

getProxiedUrlWithFallback(url: string, archiveUrl?: string | null): { primary: string, fallback: string | null }
- primary: 기존 프록시 URL (wsrv.nl, video-proxy 등)
- fallback: Wayback URL (있으면)

2. src/components/LinkCard.tsx 수정:

이미지/비디오 렌더링 부분:
- onError 핸들러 추가
- 첫 번째 실패 시 Wayback fallback URL로 교체
- 두 번째 실패 시 placeholder 이미지 표시
- useState로 currentSrc 관리

예시:
```tsx
const [imgSrc, setImgSrc] = useState(getProxiedUrl(media.url));
const [useFallback, setUseFallback] = useState(false);

const handleImageError = () => {
  if (!useFallback && link.archive_url) {
    setUseFallback(true);
    setImgSrc(getWaybackFallbackUrl(media.url, link.archive_url));
  }
};

<Image src={imgSrc} onError={handleImageError} ... />
```

주의:
- 모든 미디어에 폴백 적용 (thumbnail_url, link_media)
- 비디오는 Wayback에서 재생 안될 수 있음 (이미지만 우선)
- 무한 루프 방지 (useFallback 플래그)
  </action>
  <verify>이미지 onError 시 Wayback 폴백 동작, 빌드 성공</verify>
  <done>이미지 폴백 로직 구현됨, 원본 실패 시 Wayback URL로 교체됨</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Internet Archive 백업 시스템 UI 및 폴백 기능</what-built>
  <how-to-verify>
    1. npm run dev 실행
    2. 로그인 후 링크 카드 확인
    3. starred 토글 시 아카이브 상태 변경 확인 (환경 변수 설정 시)
    4. 아카이브 아이콘 버튼 클릭 시 동작 확인
    5. 환경 변수 없으면 아이콘 숨김 또는 비활성화 확인
    6. (선택) 깨진 이미지 URL로 폴백 동작 테스트
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 에러 없음
- [ ] ArchiveStatus 컴포넌트 존재
- [ ] LinkCard에 아카이브 상태 표시됨
- [ ] 이미지 폴백 로직 구현됨
- [ ] UI 검증 완료
</verification>

<success_criteria>

- ArchiveStatus 컴포넌트 생성됨 (4가지 상태 표시)
- LinkCard에 아카이브 상태 아이콘 통합됨
- 수동 아카이브 버튼 동작함
- 이미지 onError 시 Wayback 폴백 동작함
- UI 검증 완료
- Phase 34 complete
</success_criteria>

<output>
After completion, create `.planning/phases/34-internet-archive-backup/34-03-SUMMARY.md`
</output>
