---
phase: 34-internet-archive-backup
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/20260119000001_archive_columns.sql, src/types/database.ts, src/lib/archive.ts]
---

<objective>
Internet Archive 백업 시스템의 DB 스키마 및 API 인프라 구축.

Purpose: links 테이블에 아카이브 관련 컬럼 추가하고, archive.org SPN2 API와 통신하는 모듈 생성.
Output: DB 마이그레이션 완료, archive.ts 모듈 생성, 타입 정의 업데이트.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-internet-archive-backup/DISCOVERY.md
@src/types/database.ts
@src/lib/links.ts

**Constraining decisions:**
- Supabase CLI로 migration 관리 (`npx supabase db push`)
- 환경 변수: ARCHIVE_ORG_ACCESS_KEY, ARCHIVE_ORG_SECRET_KEY

**Tech stack:**
- Supabase PostgreSQL
- Next.js API Routes
- TypeScript
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB 스키마 확장 (archive 컬럼 추가)</name>
  <files>supabase/migrations/20260119000001_archive_columns.sql, src/types/database.ts</files>
  <action>
1. supabase/migrations/20260119000001_archive_columns.sql 생성:
   - links 테이블에 archive_status TEXT DEFAULT NULL 추가 (NULL/pending/archived/failed)
   - links 테이블에 archive_url TEXT DEFAULT NULL 추가 (Wayback 아카이브 URL)
   - links 테이블에 archive_job_id TEXT DEFAULT NULL 추가 (SPN2 job ID)
   - links 테이블에 archived_at TIMESTAMPTZ DEFAULT NULL 추가 (아카이브 완료 시간)
   - RLS 정책은 기존 links 정책이 적용되므로 별도 추가 불필요

2. src/types/database.ts 수정:
   - links Row/Insert/Update 타입에 archive_status, archive_url, archive_job_id, archived_at 필드 추가
   - archive_status 타입은 string | null (pending/archived/failed/null)

주의: archived_at은 TIMESTAMPTZ로 생성 (Supabase 표준)
  </action>
  <verify>npx supabase db push 성공, TypeScript 빌드 에러 없음</verify>
  <done>links 테이블에 4개 컬럼 추가됨, 타입 정의 업데이트됨</done>
</task>

<task type="auto">
  <name>Task 2: archive.org API 모듈 생성</name>
  <files>src/lib/archive.ts</files>
  <action>
src/lib/archive.ts 생성:

1. 환경 변수 체크:
   - ARCHIVE_ORG_ACCESS_KEY
   - ARCHIVE_ORG_SECRET_KEY
   - 없으면 에러 throw

2. saveToArchive(url: string) 함수:
   - POST https://web.archive.org/save
   - Headers: Authorization: LOW {accesskey}:{secret}
   - Body: url, capture_all=1, skip_first_archive=1
   - Return: { status, job_id, timestamp?, archive_url? }
   - 에러 시 status: 'error', message 반환

3. checkArchiveStatus(jobId: string) 함수:
   - GET https://web.archive.org/save/status/{jobId}
   - Return: { status: 'pending'|'success'|'error', timestamp?, archive_url? }

4. checkWaybackAvailability(url: string) 함수:
   - GET http://archive.org/wayback/available?url={url}
   - Return: { available: boolean, url?: string, timestamp?: string }

5. getWaybackUrl(originalUrl: string, timestamp?: string) 함수:
   - Wayback URL 생성: https://web.archive.org/web/{timestamp}/{originalUrl}
   - timestamp 없으면 최신 스냅샷 URL 반환

타입 정의:
- ArchiveSaveResult: { status, job_id, timestamp?, archive_url?, error? }
- ArchiveStatusResult: { status, timestamp?, archive_url?, error? }
- WaybackAvailability: { available, url?, timestamp? }

주의: fetch 사용, timeout 10초 설정
  </action>
  <verify>TypeScript 컴파일 성공, 함수 export 확인</verify>
  <done>archive.ts 모듈 생성, 4개 함수 export됨</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx supabase db push` 성공
- [ ] `npm run build` 에러 없음
- [ ] src/lib/archive.ts 파일 존재
- [ ] TypeScript 타입 에러 없음
</verification>

<success_criteria>

- links 테이블에 archive_status, archive_url, archive_job_id, archived_at 컬럼 추가됨
- database.ts 타입 정의 업데이트됨
- archive.ts 모듈 생성되어 saveToArchive, checkArchiveStatus, checkWaybackAvailability, getWaybackUrl 함수 export
- 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/34-internet-archive-backup/34-01-SUMMARY.md`
</output>
