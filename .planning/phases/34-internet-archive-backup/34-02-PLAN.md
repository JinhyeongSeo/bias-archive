---
phase: 34-internet-archive-backup
plan: 02
type: execute
depends_on: ["34-01"]
files_modified: [src/app/api/links/[id]/archive/route.ts, src/app/api/links/route.ts]
---

<objective>
링크 아카이브 트리거 API 및 자동 아카이브 기능 구현.

Purpose: 링크 저장 시 자동으로 archive.org에 백업하는 기능 구현.
Output: archive API 라우트, 링크 생성 시 자동 아카이브 트리거.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-internet-archive-backup/DISCOVERY.md
@.planning/phases/34-internet-archive-backup/34-01-SUMMARY.md
@src/lib/archive.ts
@src/lib/links.ts
@src/app/api/links/[id]/route.ts

**Constraining decisions:**
- 모든 링크 자동 아카이브 (Rate limit 100,000/day로 충분)
- 비동기 처리 (archiving은 백그라운드, 응답은 즉시)
- 환경 변수 없으면 아카이브 기능 비활성화
</context>

<tasks>

<task type="auto">
  <name>Task 1: 링크 아카이브 API 라우트 생성</name>
  <files>src/app/api/links/[id]/archive/route.ts</files>
  <action>
src/app/api/links/[id]/archive/route.ts 생성:

POST /api/links/[id]/archive:
1. 인증 확인 (user 필수)
2. 링크 존재 확인 및 소유권 확인 (user_id 일치)
3. ARCHIVE_ORG_ACCESS_KEY 환경 변수 확인
   - 없으면 501 Not Implemented 반환 (아카이브 기능 비활성화)
4. 이미 archive_status가 'archived'면 기존 archive_url 반환
5. saveToArchive(link.url) 호출
6. 성공 시:
   - archive_status: 'pending' 또는 'archived' (즉시 완료 시)
   - archive_job_id: job_id
   - archive_url: timestamp로 생성 (https://web.archive.org/web/{timestamp}/{url})
   - archived_at: 완료 시 현재 시간
7. links 테이블 업데이트
8. 결과 반환

GET /api/links/[id]/archive:
1. 링크의 archive_status 확인
2. pending이고 archive_job_id 있으면 checkArchiveStatus 호출
3. 완료됐으면 links 테이블 업데이트 (archived, archive_url, archived_at)
4. 현재 상태 반환

에러 처리:
- 404: 링크 없음
- 401: 인증 필요
- 403: 권한 없음
- 501: 아카이브 기능 비활성화
- 500: 아카이브 요청 실패
  </action>
  <verify>curl -X POST /api/links/[id]/archive 테스트 (환경 변수 없으면 501 반환)</verify>
  <done>archive API 라우트 생성, POST/GET 핸들러 구현됨</done>
</task>

<task type="auto">
  <name>Task 2: 링크 생성 시 자동 아카이브 트리거</name>
  <files>src/app/api/links/route.ts</files>
  <action>
src/app/api/links/route.ts POST 핸들러 수정:

1. 링크 생성 성공 후 자동 아카이브 트리거:
   - ARCHIVE_ORG_ACCESS_KEY 환경 변수 있을 때만
   - 비동기로 처리 (await 하지 않음, 응답은 즉시 반환)
   - saveToArchive 함수 import 및 호출
   - 성공 시 archive_status: 'pending', archive_job_id 저장
   - 실패해도 링크 저장은 성공으로 처리 (아카이브는 부가 기능)

2. 아카이브 트리거 로직:
   ```typescript
   // Non-blocking archive trigger
   if (process.env.ARCHIVE_ORG_ACCESS_KEY) {
     saveToArchive(link.url).then(async (result) => {
       if (result.status === 'success' || result.status === 'pending') {
         await supabase.from('links').update({
           archive_status: result.status === 'success' ? 'archived' : 'pending',
           archive_job_id: result.job_id,
           archive_url: result.archive_url,
           archived_at: result.status === 'success' ? new Date().toISOString() : null
         }).eq('id', link.id);
       }
     }).catch(console.error);
   }
   ```

주의:
- 비동기 처리로 UX 영향 없음
- 환경 변수 없으면 조용히 스킵 (에러 아님)
- Rate limit: 100,000/day로 개인 사용에 충분
  </action>
  <verify>링크 생성 API 테스트, 빌드 성공</verify>
  <done>링크 생성 시 자동 아카이브 트리거됨, 비동기 처리됨</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 에러 없음
- [ ] POST /api/links/[id]/archive 엔드포인트 존재
- [ ] GET /api/links/[id]/archive 엔드포인트 존재
- [ ] PATCH /api/links/[id] starred 변경 시 아카이브 트리거 로직 포함
</verification>

<success_criteria>

- /api/links/[id]/archive POST/GET 라우트 생성됨
- 링크 생성 시 자동 아카이브 트리거됨 (환경 변수 있을 때)
- 환경 변수 없으면 501 반환 또는 조용히 스킵
- 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/34-internet-archive-backup/34-02-SUMMARY.md`
</output>
