---
phase: 32-namuwiki-fallback-search
plan: 32-01-FIX
type: fix
---

<objective>
Fix 2 UAT issues from plan 32-01.

Source: 32-01-ISSUES.md
Priority: 0 critical, 1 major, 1 minor
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/32-namuwiki-fallback-search/32-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/32-namuwiki-fallback-search/32-01-PLAN.md

**Key files:**
@src/components/BiasManager.tsx
@src/lib/parsers/namuwiki.ts
@src/app/api/kpop/groups/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-002 - Namuwiki 폴백 검색 미작동</name>
  <files>src/lib/parsers/namuwiki.ts</files>
  <action>
나무위키 파서 로직 수정:

1. **디버깅을 위한 로그 추가:**
   - fetchHtmlFromNamuwiki에서 응답 상태 로깅
   - searchGroupFromNamuwiki에서 파싱 단계별 로깅

2. **나무위키 페이지 구조 재분석:**
   - 나무위키는 SPA로 동작하여 서버사이드 HTML에 콘텐츠가 없을 수 있음
   - API 엔드포인트 사용 검토: `https://namu.wiki/raw/그룹명` (raw 문서)
   - 또는 모바일 버전: `https://namu.wiki/w/그룹명` with mobile user-agent

3. **대안: raw 문서 파싱:**
   - `/raw/` 엔드포인트는 나무마크 문법의 원본 텍스트 반환
   - 멤버 목록은 `|| 멤버명 ||` 테이블 형식 또는 `* 멤버명` 리스트 형식
   - 정규식으로 멤버 추출

4. **"하이키" 그룹 테스트:**
   - 실제 나무위키 페이지 분석 (https://namu.wiki/w/하이키)
   - 파싱 로직이 해당 페이지 구조와 호환되는지 확인

**주의:**
- 나무위키는 JavaScript 렌더링이 필요할 수 있음 (SSR이 아닐 경우)
- raw 문서는 인코딩 문제 없이 순수 텍스트
  </action>
  <verify>
API 테스트:
- `curl 'http://localhost:3000/api/kpop/groups?q=하이키'` → namuwiki 폴백 결과 반환
- 콘솔 로그에서 파싱 과정 확인
  </verify>
  <done>
나무위키 폴백이 "하이키" 등 selca에 없는 그룹에서 정상 작동
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-001 - selca 출처 배지 추가</name>
  <files>src/components/BiasManager.tsx</files>
  <action>
BiasManager에서 selca 그룹에도 출처 배지 추가:

1. **검색 결과 드롭다운 (line 1063-1069):**
   - 현재: namuwiki만 배지 표시
   - 수정: selca 그룹에도 보라색 배지 추가
   ```tsx
   {group.source === 'selca' && (
     <span className="ml-1 px-1 py-0.5 text-[10px] font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 rounded">
       selca
     </span>
   )}
   ```

2. **선택된 그룹 헤더 (line 1091-1096):**
   - 현재: namuwiki만 배지 표시
   - 수정: selca 그룹에도 보라색 배지 추가

**주의:**
- selca는 기본 소스이므로 source 필드가 없을 수 있음 → undefined 또는 'selca' 모두 처리
- API 응답에서 source 필드가 항상 포함되도록 이미 32-01에서 수정됨
  </action>
  <verify>
개발 서버에서 테스트:
1. 그룹 검색 시 selca 결과에 보라색 "selca" 배지 표시
2. 그룹 선택 후 헤더에도 배지 표시
  </verify>
  <done>
selca와 namuwiki 모두 출처 배지 표시됨 (selca: 보라색, namuwiki: 초록색)
  </done>
</task>

</tasks>

<verification>
Before declaring fix complete:
- [ ] UAT-002: 나무위키 폴백 검색이 "하이키" 등 그룹에서 작동
- [ ] UAT-001: selca 그룹 검색 시 보라색 배지 표시
- [ ] `npm run build` 성공 (TypeScript 에러 없음)
- [ ] 기존 selca 검색 기능 영향 없음
</verification>

<success_criteria>
- All UAT issues from 32-01-ISSUES.md addressed
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/32-namuwiki-fallback-search/32-01-FIX-SUMMARY.md`
</output>
