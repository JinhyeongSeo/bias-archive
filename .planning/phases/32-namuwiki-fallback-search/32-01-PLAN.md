---
phase: 32-namuwiki-fallback-search
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/parsers/namuwiki.ts
  - src/app/api/kpop/groups/route.ts
  - src/app/api/kpop/groups/[groupId]/members/route.ts
  - src/components/BiasManager.tsx
---

<objective>
selca.kastden.org에 없는 아이돌 그룹을 나무위키에서 폴백 검색하여 멤버 목록 자동 추출

Purpose: selca에 등록되지 않은 아이돌(신규 그룹, 마이너 그룹)도 그룹명 입력만으로 멤버 자동 추가 가능
Output: 나무위키 파서 모듈 + API 폴백 로직 + UI 출처 표시
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/parsers/selca.ts
@src/lib/selca-types.ts
@src/app/api/kpop/groups/route.ts
@src/app/api/kpop/groups/[groupId]/members/route.ts
@src/components/BiasManager.tsx

**Background:**
- selca.kastden.org가 K-pop 아이돌 데이터 소스지만, 신규/마이너 그룹은 누락됨
- 나무위키는 대부분의 K-pop 그룹 정보를 최신 상태로 유지
- robots.txt에서 `/w/` 경로 크롤링 허용 (CC BY-NC-SA 2.0 KR 라이선스)

**나무위키 페이지 구조 분석:**
- 그룹 페이지 URL: `https://namu.wiki/w/{그룹명}` (URL 인코딩 필요)
- 멤버 정보: 테이블 형식, 프로필 이미지 + 이름 링크 + 생년월일 + 포지션
- 이름 패턴: 한글 이름이 링크, 영어 로마자 표기는 별도 섹션 또는 괄호 내

**기존 패턴 활용:**
- node-html-parser 사용 (heye, kgirls 파서와 동일)
- KpopGroup, KpopMember 타입 재사용 (selca-types.ts)
- 인메모리 캐시 패턴 (10분 TTL)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 나무위키 파서 모듈 생성</name>
  <files>src/lib/parsers/namuwiki.ts</files>
  <action>
나무위키에서 K-pop 그룹 멤버 정보를 파싱하는 모듈 생성:

1. **함수 구현:**
   - `searchGroupFromNamuwiki(groupName: string): Promise<NamuwikiGroup | null>` - 그룹 페이지 존재 여부 확인
   - `getGroupMembersFromNamuwiki(groupName: string): Promise<NamuwikiMembersResult>` - 멤버 목록 추출

2. **타입 정의:**
   - NamuwikiGroup: { name, name_ko, name_en, memberCount }
   - NamuwikiMembersResult: { groupName, groupNameKo, members: NamuwikiMember[], source: 'namuwiki' }
   - NamuwikiMember: { name_ko, name_en?, position? }

3. **파싱 로직:**
   - URL: `https://namu.wiki/w/${encodeURIComponent(groupName)}`
   - 멤버 테이블 찾기: `tbody tr` 내 `a[href^="/w/"]` 링크에서 한글 이름 추출
   - 영어 이름: 같은 행의 다른 셀 또는 멤버 개별 페이지에서 추출 (선택적)
   - User-Agent 설정: 일반 브라우저로 위장 (봇 차단 방지)

4. **캐시:**
   - 인메모리 Map 캐시 (10분 TTL)
   - 그룹별 캐시 키: groupName.toLowerCase()

5. **에러 처리:**
   - 404: null 반환 (그룹 페이지 없음)
   - 파싱 실패: 빈 멤버 배열 반환
   - 타임아웃: 10초 제한

**주의:**
- 나무위키 HTML 구조는 복잡함 - 멤버 테이블 위치가 그룹마다 다를 수 있음
- "멤버" 또는 "구성원" 섹션 헤더를 찾아 그 아래 테이블 파싱
- 솔로 아티스트 페이지는 스킵 (멤버 테이블 없음)
  </action>
  <verify>
TypeScript 컴파일: `npx tsc --noEmit src/lib/parsers/namuwiki.ts`
모듈 로드 가능 여부 확인
  </verify>
  <done>
namuwiki.ts 파일 생성, 타입 정의 완료, 파싱 함수 구현, 캐시 적용
  </done>
</task>

<task type="auto">
  <name>Task 2: API 라우트에 나무위키 폴백 통합</name>
  <files>src/app/api/kpop/groups/route.ts, src/app/api/kpop/groups/[groupId]/members/route.ts</files>
  <action>
기존 K-pop API에 나무위키 폴백 로직 추가:

**1. /api/kpop/groups (검색 API):**
   - 기존 selca searchGroups 호출 → 결과 있으면 반환
   - 결과 없으면 나무위키에서 그룹 검색 시도
   - 응답에 `source: 'selca' | 'namuwiki'` 필드 추가

**2. /api/kpop/groups/[groupId]/members (멤버 조회 API):**
   - groupId가 'namuwiki:그룹명' 형식이면 나무위키에서 조회
   - 그 외는 기존 selca 로직 유지
   - 응답에 `source: 'selca' | 'namuwiki'` 필드 추가

**3. 응답 형식 통일:**
   - 나무위키 멤버도 KpopMember 형식으로 변환
   - id는 `namuwiki_${name_ko}` 형식 (selca slug 없음)
   - hasSelcaOwner: false (나무위키 소스는 selca 검색 불가)

**주의:**
- selca 먼저 시도, 실패 시에만 나무위키 폴백
- 나무위키 결과는 selca_slug 없으므로 외부 검색 기능 제한됨을 UI에 표시 필요
  </action>
  <verify>
API 테스트:
- `curl 'http://localhost:3000/api/kpop/groups?q=아이브'` → selca 결과
- `curl 'http://localhost:3000/api/kpop/groups?q=존재하지않는그룹'` → namuwiki 폴백 시도
  </verify>
  <done>
두 API 모두 나무위키 폴백 지원, source 필드 포함, 기존 selca 로직 유지
  </done>
</task>

<task type="auto">
  <name>Task 3: BiasManager UI에 출처 표시 및 안내</name>
  <files>src/components/BiasManager.tsx</files>
  <action>
나무위키 소스 그룹 선택 시 UI 업데이트:

1. **출처 표시:**
   - 그룹 검색 결과에 출처 아이콘/배지 표시 (selca: 보라색, namuwiki: 초록색)
   - 드롭다운 항목에 작은 텍스트로 "(나무위키)" 표시

2. **안내 메시지:**
   - 나무위키 소스 그룹 선택 시 안내 표시:
     "나무위키에서 가져온 데이터입니다. 외부 검색(selca) 기능이 제한됩니다."
   - 멤버 추가 시에도 selca_slug 없음 안내

3. **멤버 체크박스:**
   - 나무위키 멤버도 동일하게 체크박스 표시
   - hasSelcaOwner 필드 없으므로 모두 false 처리

4. **타입 업데이트:**
   - KpopGroup 인터페이스에 source?: 'selca' | 'namuwiki' 추가
   - selectedGroup 상태에 source 저장

**주의:**
- 기존 selca 그룹 선택 로직 영향 없도록 주의
- 나무위키 그룹도 동일한 일괄 추가 흐름 사용
  </action>
  <verify>
개발 서버에서 그룹 검색 테스트:
1. selca에 있는 그룹 검색 → 기존과 동일하게 동작
2. selca에 없는 그룹 검색 → 나무위키 폴백 결과 표시 (출처 표시 확인)
  </verify>
  <done>
출처 배지 표시, 나무위키 안내 메시지, 타입 업데이트 완료
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 성공 (TypeScript 에러 없음)
- [ ] selca에 있는 그룹 검색 시 기존과 동일하게 동작
- [ ] selca에 없는 그룹 검색 시 나무위키 폴백 동작
- [ ] 나무위키 소스 멤버 일괄 추가 정상 동작
- [ ] 출처 표시 UI 정상 렌더링
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- selca → namuwiki 폴백 흐름 정상 동작
- 사용자에게 데이터 출처 명확히 표시
</success_criteria>

<output>
After completion, create `.planning/phases/32-namuwiki-fallback-search/32-01-SUMMARY.md`:

# Phase 32 Plan 01: Namuwiki Fallback Search Summary

**[요약]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/lib/parsers/namuwiki.ts` - 나무위키 파서 모듈
- `src/app/api/kpop/groups/route.ts` - 그룹 검색 API 폴백 추가
- `src/app/api/kpop/groups/[groupId]/members/route.ts` - 멤버 조회 API 폴백 추가
- `src/components/BiasManager.tsx` - UI 출처 표시

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for next phase
</output>
