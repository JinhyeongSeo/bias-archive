---
phase: 35-instagram-search
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/parsers/instagram.ts
  - src/lib/parsers/index.ts
  - src/lib/metadata.ts
  - src/app/api/search/instagram/route.ts
  - src/components/UnifiedSearch.tsx
  - src/components/LinkCard.tsx
  - package.json
---

<objective>
Instagram 카테고리 추가 및 검색 기능 구현

Purpose: UnifiedSearch에서 Instagram 해시태그/사용자 검색 및 Instagram URL 저장 지원
Output: UnifiedSearch Instagram 탭, URL 파서, 플랫폼 표시 완료
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-instagram-search/DISCOVERY.md

# 기존 패턴 참조:
@src/lib/parsers/twitter.ts
@src/lib/parsers/index.ts
@src/lib/metadata.ts
@src/app/api/search/selca/route.ts
@src/components/UnifiedSearch.tsx (Platform 타입, PLATFORMS 배열, searchSelca 함수 패턴)
@src/components/LinkCard.tsx

**Tech stack available:** Next.js 16, TypeScript, Tailwind CSS 4, framer-motion
**Established patterns:**
- 파서 모듈: parsers/{platform}.ts → index.ts에서 export
- 검색 API: api/search/{platform}/route.ts
- UnifiedSearch: Platform 타입, PLATFORMS 배열, search{Platform} 함수, 결과 캐싱
- LinkCard: PLATFORM_COLORS, PLATFORM_LABELS
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instagram URL 파서 및 플랫폼 통합</name>
  <files>src/lib/parsers/instagram.ts, src/lib/parsers/index.ts, src/lib/metadata.ts</files>
  <action>
1. parsers/instagram.ts 생성:
   - parseInstagram(url) 함수 구현
   - URL 패턴: instagram.com/p/{id}, instagram.com/reel/{id}, instagram.com/{username}
   - 메타데이터 추출: HTML 메타태그 파싱 (og:title, og:image, og:description)
   - fetch with AbortController (5초 타임아웃)
   - 반환: VideoMetadata 타입 (platform: 'instagram')

2. parsers/index.ts 수정:
   - Platform 타입에 'instagram' 추가
   - parseInstagram export 추가

3. metadata.ts 수정:
   - detectPlatform(): instagram.com 호스트 감지 → 'instagram' 반환
   - getParser(): 'instagram' case 추가 → parseInstagram 반환
   - parseInstagram import 추가

Instagram HTML 메타태그 파싱 예시:
```typescript
const response = await fetch(url, { signal: controller.signal })
const html = await response.text()
// og:title, og:image 추출
const titleMatch = html.match(/<meta property="og:title" content="([^"]*)"/)
const imageMatch = html.match(/<meta property="og:image" content="([^"]*)"/)
```

Note: Instagram은 서버사이드에서 직접 fetch 시 제한적인 메타데이터만 반환할 수 있음.
실패 시 URL을 제목으로 사용하고 platform만 설정하는 fallback 처리.
  </action>
  <verify>
npm run build 성공 (타입 에러 없음)
Instagram URL 감지: detectPlatform('https://instagram.com/p/test') === 'instagram'
  </verify>
  <done>
- parsers/instagram.ts 생성, parseInstagram 함수 구현
- Platform 타입에 'instagram' 추가
- metadata.ts에서 Instagram 플랫폼 감지 및 파서 연결
- npm run build 성공
  </done>
</task>

<task type="auto">
  <name>Task 2: Apify Instagram 검색 API 라우트</name>
  <files>src/app/api/search/instagram/route.ts, package.json</files>
  <action>
1. apify-client 패키지 설치:
   ```bash
   npm install apify-client
   ```

2. api/search/instagram/route.ts 생성:
   - GET 엔드포인트
   - Query params: q (검색어), type (user/hashtag, 기본 hashtag), limit (기본 20)
   - APIFY_API_TOKEN 환경변수 체크
   - ApifyClient로 'apify/instagram-search-scraper' Actor 실행
   - 결과를 UnifiedSearch 호환 형식으로 변환:
     ```typescript
     {
       results: [{
         url: string,        // 프로필 URL (user) 또는 해시태그 페이지 (hashtag)
         title: string,      // 사용자명 또는 해시태그
         thumbnailUrl: string | null,  // 프로필 이미지
         author: string      // username
       }],
       hasMore: boolean
     }
     ```

3. 에러 처리:
   - APIFY_API_TOKEN 미설정 시 { notConfigured: true } 반환
   - API 에러 시 적절한 에러 메시지

Apify Instagram Search Scraper 입력:
```typescript
const input = {
  search: query,
  searchType: type, // 'user' | 'hashtag'
  resultsLimit: limit
}
```

Note: Apify Actor 실행은 비동기이며 완료까지 수 초 소요될 수 있음.
actor.call()은 실행 완료까지 대기 후 결과 반환.
  </action>
  <verify>
npm run build 성공
APIFY_API_TOKEN 미설정 시: curl localhost:3000/api/search/instagram?q=test → { notConfigured: true }
  </verify>
  <done>
- apify-client 패키지 설치
- api/search/instagram/route.ts 생성
- Apify Instagram Search Scraper 연동
- notConfigured 처리 포함
  </done>
</task>

<task type="auto">
  <name>Task 3: UnifiedSearch Instagram 탭 및 LinkCard 플랫폼 표시</name>
  <files>src/components/UnifiedSearch.tsx, src/components/LinkCard.tsx</files>
  <action>
1. UnifiedSearch.tsx 수정:

   a) Platform 타입에 'instagram' 추가:
   ```typescript
   type Platform = "youtube" | "twitter" | "heye" | "kgirls" | "kgirls-issue" | "selca" | "instagram";
   ```

   b) InstagramResult 인터페이스 추가:
   ```typescript
   interface InstagramResult {
     url: string;
     title: string;
     thumbnailUrl: string | null;
     author: string;
   }
   ```

   c) PLATFORMS 배열에 Instagram 추가:
   ```typescript
   {
     id: "instagram",
     label: "Instagram",
     color: "text-pink-600 dark:text-pink-400",
     bgColor: "bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/50 dark:to-pink-900/50",
     ringColor: "ring-pink-500/20",
   }
   ```

   d) searchInstagram 함수 추가 (searchSelca 패턴 참조):
   ```typescript
   const searchInstagram = async (
     searchQuery: string,
     searchType: 'user' | 'hashtag' = 'hashtag'
   ): Promise<{ results: EnrichedResult[]; hasMore: boolean }> => {
     const params = new URLSearchParams({
       q: searchQuery,
       type: searchType,
       limit: String(API_FETCH_COUNT),
     });

     const response = await fetch(`/api/search/instagram?${params}`);
     const data = await response.json();

     if (!response.ok) {
       if (data.notConfigured) {
         throw new Error("Instagram 검색이 설정되지 않았습니다");
       }
       throw new Error(data.error || "Instagram 검색 실패");
     }

     const results = (data.results as InstagramResult[]).map((item) => ({
       url: item.url,
       title: item.title,
       thumbnailUrl: item.thumbnailUrl,
       author: item.author,
       platform: "instagram" as Platform,
       isSaved: checkIfSaved(item.url),
       isSaving: false,
     }));

     return { results, hasMore: data.hasMore || false };
   };
   ```

   e) searchPlatform 함수에 instagram case 추가:
   기존 switch문에 instagram case 추가

   f) loadMore 함수에 instagram case 추가:
   Instagram은 페이지네이션 없이 일회성 검색으로 구현 (MVP)

2. LinkCard.tsx 수정:
   - PLATFORM_LABELS에 instagram: 'Instagram' 추가
   - PLATFORM_COLORS에 instagram 색상 추가:
     ```typescript
     instagram: 'bg-gradient-to-r from-purple-500 to-pink-500'
     ```
     또는 단순화: 'bg-pink-500'
  </action>
  <verify>
npm run build 성공
UnifiedSearch에 Instagram 탭 표시됨
LinkCard에서 platform='instagram' 시 레이블과 색상 표시됨
  </verify>
  <done>
- UnifiedSearch에 Instagram 탭 추가
- searchInstagram 함수 구현
- LinkCard에 Instagram 플랫폼 색상/레이블 추가
- npm run build 성공
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Instagram 검색 및 저장 기능 (UnifiedSearch)</what-built>
  <how-to-verify>
1. .env.local에 APIFY_API_TOKEN 추가 (Apify 계정에서 발급)
2. npm run dev 실행
3. 통합검색 (UnifiedSearch) 모달 열기
4. Instagram 탭 클릭
5. 검색어 입력 후 검색 (예: "ive", "aespa")
6. 검색 결과 확인 (썸네일, 제목 표시)
7. 결과 선택 후 저장
8. 저장된 링크 확인 (Instagram 배지 표시)

Note: APIFY_API_TOKEN 없이 테스트 시 "Instagram 검색이 설정되지 않았습니다" 메시지 확인
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build 성공 (타입 에러 없음)
- [ ] Instagram URL 감지 동작 (detectPlatform)
- [ ] Instagram 검색 API 동작 (with APIFY_API_TOKEN)
- [ ] UnifiedSearch Instagram 탭 표시
- [ ] LinkCard Instagram 플랫폼 표시
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Instagram 검색 및 저장 기능 동작
- Phase 35 complete
</success_criteria>

<output>
After completion, create `.planning/phases/35-instagram-search/35-01-SUMMARY.md`
</output>
