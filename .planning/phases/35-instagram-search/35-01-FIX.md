---
phase: 35-instagram-search
plan: 35-01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 35-01.

Source: 35-01-ISSUES.md
Priority: 1 blocker, 1 major, 1 minor
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/35-instagram-search/35-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/35-instagram-search/35-01-PLAN.md

**Key files:**
@src/components/UnifiedSearch.tsx (enabledPlatforms state, searchInstagram function)
@src/app/api/search/instagram/route.ts
@src/lib/parsers/instagram.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-003 - Instagram 검색 undefined map 에러</name>
  <files>src/app/api/search/instagram/route.ts, src/components/UnifiedSearch.tsx</files>
  <action>
**문제:** Instagram 검색 시 "Cannot read properties of undefined (reading 'map')" 에러 발생

**원인 분석:**
1. API 응답의 results가 undefined인 경우 처리 부족
2. notConfigured 응답 시에도 results에 접근 시도

**수정 사항:**

1. src/app/api/search/instagram/route.ts:
   - notConfigured 응답에 빈 results 배열 추가:
     ```typescript
     return NextResponse.json({ notConfigured: true, results: [], hasMore: false })
     ```

2. src/components/UnifiedSearch.tsx의 searchInstagram 함수:
   - notConfigured 체크를 response.ok 확인 전에 먼저 처리
   - results가 undefined인 경우 빈 배열로 처리:
     ```typescript
     const results = (data.results || [] as InstagramResult[]).map(...)
     ```
  </action>
  <verify>
- APIFY_API_TOKEN 미설정 상태에서 Instagram 검색 시 "설정되지 않았습니다" 메시지만 표시되고 에러 없음
- npm run build 성공
  </verify>
  <done>
- API에서 notConfigured 시 빈 results 배열 포함
- 클라이언트에서 results undefined 방어 처리
- JavaScript 에러 해결
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-002 - Instagram 탭 기본 선택 상태</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
**문제:** Instagram 탭이 기본적으로 해제되어 있음

**원인:** enabledPlatforms useState 초기값에 "instagram"이 포함되지 않음

**수정 사항:**

src/components/UnifiedSearch.tsx의 enabledPlatforms 초기값 수정:
```typescript
// Before
const [enabledPlatforms, setEnabledPlatforms] = useState<Set<Platform>>(
  new Set(["youtube", "twitter", "heye", "kgirls", "kgirls-issue", "selca"])
);

// After
const [enabledPlatforms, setEnabledPlatforms] = useState<Set<Platform>>(
  new Set(["youtube", "twitter", "heye", "kgirls", "kgirls-issue", "selca", "instagram"])
);
```
  </action>
  <verify>
- 통합검색 모달 열었을 때 Instagram 탭이 기본 선택(체크)된 상태
- npm run build 성공
  </verify>
  <done>
- enabledPlatforms 초기값에 "instagram" 추가
- Instagram 탭 기본 선택 상태로 시작
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-001 - Instagram URL 파서 메타데이터 추출</name>
  <files>src/lib/parsers/instagram.ts</files>
  <action>
**문제:** Instagram URL 입력 시 메타데이터가 추출되지 않음

**원인 분석:**
- Instagram은 서버사이드 fetch에 대해 로그인 요구 또는 제한된 응답 반환
- 현재 User-Agent가 봇으로 감지되어 차단될 가능성

**수정 사항:**

src/lib/parsers/instagram.ts 개선:

1. User-Agent 변경 (브라우저처럼):
   ```typescript
   headers: {
     'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
     'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
     'Accept-Language': 'en-US,en;q=0.9,ko;q=0.8',
     'Sec-Fetch-Dest': 'document',
     'Sec-Fetch-Mode': 'navigate',
     'Sec-Fetch-Site': 'none',
     'Sec-Fetch-User': '?1',
     'Upgrade-Insecure-Requests': '1',
   }
   ```

2. JSON-LD 스크립트 파싱 추가 (더 안정적인 메타데이터 소스):
   ```typescript
   // Try JSON-LD first (more reliable when available)
   const jsonLdMatch = html.match(/<script type="application\/ld\+json"[^>]*>([^<]+)<\/script>/i)
   if (jsonLdMatch) {
     try {
       const jsonLd = JSON.parse(jsonLdMatch[1])
       // Extract from JSON-LD
     } catch {}
   }
   ```

3. 대체 메타태그 패턴 추가:
   - twitter:title, twitter:image 메타태그도 체크
   - name="description" 메타태그 체크

**Note:** Instagram의 서버사이드 메타데이터 추출은 제한적일 수 있음.
Fallback으로 URL에서 ID 추출하여 최소한의 정보 제공하는 것이 현실적.
  </action>
  <verify>
- Instagram URL 입력 시 가능한 메타데이터 추출 (또는 fallback 동작)
- npm run build 성공
  </verify>
  <done>
- User-Agent 브라우저 형식으로 변경
- JSON-LD 및 대체 메타태그 파싱 추가
- Fallback 처리 개선
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-003 해결: Instagram 검색 시 JavaScript 에러 없음
- [ ] UAT-002 해결: Instagram 탭 기본 선택 상태
- [ ] UAT-001 해결: Instagram URL 파서 메타데이터 추출 개선
- [ ] npm run build 성공
</verification>

<success_criteria>
- All UAT issues from 35-01-ISSUES.md addressed
- Tests pass (npm run build)
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/35-instagram-search/35-01-FIX-SUMMARY.md`
</output>
