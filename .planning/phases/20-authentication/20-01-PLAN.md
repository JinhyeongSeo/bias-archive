---
phase: 20-authentication
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/20260114000005_user_auth.sql, src/types/database.ts, src/lib/supabase.ts, src/lib/supabase-server.ts, src/lib/supabase-middleware.ts, package.json]
---

<objective>
Supabase Auth 기반 인증 인프라 구축: DB 스키마에 user_id 추가, RLS 정책 설정, @supabase/ssr 기반 서버/클라이언트 구성

Purpose: 멀티 사용자 지원을 위한 인증 기반 마련
Output: Auth 지원 DB 스키마, SSR 호환 Supabase 클라이언트
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/supabase.ts
@src/types/database.ts
@supabase/migrations/20260113000001_initial_schema.sql

**Tech stack:**
- Supabase (@supabase/supabase-js ^2.90.1)
- Next.js 16.1.1 with App Router
- next-intl for i18n ([locale] routing)

**Established patterns:**
- src/lib/ for utility modules
- src/types/database.ts for Supabase types
- supabase/migrations/ for DB schema
- `npx supabase db push` for migration

**Constraining decisions:**
- npm 사용 (pnpm 미설치)
- Supabase CLI로 migration 관리
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB 스키마 확장 - user_id 및 RLS 정책</name>
  <files>supabase/migrations/20260114000005_user_auth.sql</files>
  <action>
Migration 파일 생성:
1. biases, groups, links, tags, link_tags, link_media 테이블에 user_id UUID 컬럼 추가 (nullable, FK to auth.users)
2. 각 테이블에 RLS 활성화 (ALTER TABLE ... ENABLE ROW LEVEL SECURITY)
3. 각 테이블에 SELECT/INSERT/UPDATE/DELETE 정책 추가:
   - SELECT: auth.uid() = user_id OR user_id IS NULL (기존 데이터 접근 허용)
   - INSERT: auth.uid() IS NOT NULL (인증된 사용자만)
   - UPDATE/DELETE: auth.uid() = user_id
4. 인덱스 추가: CREATE INDEX ON each_table(user_id)

주의: user_id는 nullable로 시작 (기존 데이터 호환). 나중에 마이그레이션 후 NOT NULL로 변경 가능.
RLS 정책은 user_id IS NULL인 기존 데이터도 읽을 수 있도록 설정.
  </action>
  <verify>npx supabase db push --dry-run으로 문법 검증, 실제 push로 적용</verify>
  <done>Migration 파일 생성됨, supabase db push 성공, 테이블에 user_id 컬럼과 RLS 정책 적용됨</done>
</task>

<task type="auto">
  <name>Task 2: @supabase/ssr 설치 및 클라이언트 설정</name>
  <files>package.json, src/lib/supabase.ts, src/lib/supabase-server.ts, src/lib/supabase-middleware.ts, src/types/database.ts</files>
  <action>
1. npm install @supabase/ssr 실행

2. src/lib/supabase.ts 수정:
   - createBrowserClient 사용으로 변경 (@supabase/ssr)
   - 기존 createClient 대신 SSR 호환 브라우저 클라이언트

3. src/lib/supabase-server.ts 생성:
   - createServerClient 함수 (cookies() 사용)
   - Server Component와 Route Handler에서 사용
   - cookieStore에서 읽기/쓰기 처리

4. src/lib/supabase-middleware.ts 생성:
   - createMiddlewareClient 함수 (request, response 처리)
   - Middleware에서 세션 새로고침용

5. src/types/database.ts 업데이트:
   - 모든 테이블에 user_id 필드 추가 (Row, Insert, Update)

@supabase/ssr 패턴 사용 이유: Next.js App Router의 서버 컴포넌트, 라우트 핸들러, 미들웨어 각각에서 쿠키 기반 인증 세션을 올바르게 처리하기 위함.
  </action>
  <verify>npm run build 성공, import 오류 없음</verify>
  <done>@supabase/ssr 설치됨, 3가지 클라이언트(browser, server, middleware) 설정 완료, 타입 업데이트됨</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx supabase db push` 성공
- [ ] `npm run build` 오류 없음
- [ ] src/lib/supabase*.ts 파일들이 올바르게 export됨
- [ ] Database 타입에 user_id 필드 포함됨
</verification>

<success_criteria>

- user_id 컬럼이 모든 테이블에 추가됨
- RLS 정책이 활성화되어 인증된 사용자만 데이터 수정 가능
- @supabase/ssr 기반 클라이언트 3종 설정 완료
- 빌드 성공
  </success_criteria>

<output>
After completion, create `.planning/phases/20-authentication/20-01-SUMMARY.md`
</output>
