---
phase: 20-authentication
plan: 03
type: execute
depends_on: ["20-02"]
files_modified: [src/middleware.ts, src/app/api/*/route.ts, src/lib/biases.ts, src/lib/links.ts, src/lib/groups.ts, src/lib/tags.ts]
---

<objective>
인증 미들웨어 및 API 보호: 세션 새로고침, API 라우트에서 user_id 자동 주입

Purpose: 인증된 사용자만 데이터 생성/수정 가능하도록 보호
Output: 미들웨어로 세션 관리, API에서 user_id 자동 할당
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-authentication/20-01-SUMMARY.md
@.planning/phases/20-authentication/20-02-SUMMARY.md
@src/lib/supabase-middleware.ts
@src/lib/supabase-server.ts
@src/app/api/biases/route.ts
@src/app/api/links/route.ts

**Established patterns:**
- src/lib/*.ts for DB operations
- src/app/api/**/route.ts for API routes
- next-intl middleware already exists (if any)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js 미들웨어로 세션 새로고침</name>
  <files>src/middleware.ts</files>
  <action>
1. src/middleware.ts 생성 또는 수정:
   - createMiddlewareClient로 Supabase 클라이언트 생성
   - supabase.auth.getUser()로 세션 새로고침 (토큰 갱신)
   - 응답 헤더에 쿠키 설정
   - next-intl middleware와 통합 (이미 있다면)

2. matcher 설정:
   - API 라우트 제외: '/((?!api|_next/static|_next/image|favicon.ico).*)'
   - 또는 모든 경로에 적용 후 조건부 처리

목적:
- 페이지 요청마다 세션 토큰 자동 갱신
- 만료된 세션 자동 로그아웃
- SSR에서 인증 상태 일관성 유지
  </action>
  <verify>npm run dev로 페이지 이동 시 콘솔 에러 없음</verify>
  <done>미들웨어가 세션을 새로고침하고, next-intl과 통합됨</done>
</task>

<task type="auto">
  <name>Task 2: API 라우트에서 user_id 자동 주입</name>
  <files>src/lib/biases.ts, src/lib/links.ts, src/lib/groups.ts, src/lib/tags.ts, src/app/api/biases/route.ts, src/app/api/links/route.ts, src/app/api/groups/route.ts</files>
  <action>
1. src/lib/*.ts DB 함수들 수정:
   - 각 create 함수에 userId 파라미터 추가 (optional)
   - INSERT 시 user_id 값 포함
   - 예: createBias(name, groupName, ..., userId)
   - 예: createLink(data, userId)

2. API 라우트 수정:
   - createServerClient로 인증된 Supabase 클라이언트 생성
   - supabase.auth.getUser()로 현재 사용자 확인
   - POST/PUT/DELETE 요청 시:
     - 인증 안 됨 → 401 Unauthorized 반환
     - 인증됨 → user.id를 DB 함수에 전달
   - GET 요청: 인증 없이도 허용 (RLS가 필터링)

수정 대상 API:
- /api/biases (POST)
- /api/biases/[id] (PUT, DELETE)
- /api/biases/batch (POST)
- /api/links (POST)
- /api/links/[id] (PUT, DELETE)
- /api/groups (POST)
- /api/groups/[id] (PUT, DELETE)
- /api/tags (POST)

패턴:
```typescript
const supabase = createServerClient()
const { data: { user } } = await supabase.auth.getUser()
if (!user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
// user.id를 사용
```
  </action>
  <verify>npm run build 성공, API 호출 시 인증 체크 작동</verify>
  <done>모든 데이터 수정 API가 인증을 요구하고, user_id를 자동으로 저장함</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>인증 시스템 전체 (스키마, UI, 미들웨어, API 보호)</what-built>
  <how-to-verify>
    1. npm run dev로 개발 서버 시작
    2. /ko/signup에서 새 계정 생성 (이메일 확인 필요할 수 있음)
    3. /ko/login에서 로그인
    4. Header에 사용자 이메일 표시 확인
    5. 새 최애(bias) 추가 시도 → 성공해야 함
    6. 로그아웃 후 새 최애 추가 시도 → 실패해야 함 (401)
    7. Supabase 대시보드에서 biases 테이블의 user_id 확인
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 미들웨어가 세션을 새로고침함
- [ ] 비인증 사용자의 POST 요청이 401 반환
- [ ] 인증된 사용자의 POST 요청이 user_id와 함께 저장됨
- [ ] 기존 데이터(user_id IS NULL)는 여전히 읽기 가능
</verification>

<success_criteria>

- 인증된 사용자만 데이터 생성/수정/삭제 가능
- user_id가 자동으로 데이터에 할당됨
- 기존 데이터 접근성 유지 (하위 호환)
- Phase 20 Authentication 완료
  </success_criteria>

<output>
After completion, create `.planning/phases/20-authentication/20-03-SUMMARY.md`:

# Phase 20 Plan 03: Protected Routes & API Summary

**인증 시스템 완성 - 미들웨어 세션 관리, API 보호, user_id 자동 할당**

## Accomplishments

- 미들웨어로 세션 자동 새로고침
- 모든 데이터 수정 API에 인증 요구
- user_id 자동 할당 패턴 구현

## Files Created/Modified

- `src/middleware.ts` - 세션 새로고침
- `src/lib/*.ts` - userId 파라미터 추가
- `src/app/api/**/route.ts` - 인증 체크 추가

## Decisions Made

- GET 요청은 인증 없이 허용 (RLS가 필터링)
- 기존 데이터(user_id IS NULL)는 모든 사용자가 읽기 가능

## Issues Encountered

[구현 중 발생한 문제와 해결책]

## Next Step

Phase 20 Authentication 완료. 소셜 로그인(Google) 추가는 향후 고려.
</output>
