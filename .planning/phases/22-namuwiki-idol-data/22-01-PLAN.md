---
phase: 22-namuwiki-idol-data
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/parsers/selca.ts, src/app/api/kpop/groups/route.ts, src/app/api/kpop/groups/[id]/members/route.ts, src/app/api/kpop/members/route.ts]
---

<objective>
selca.kastden.org에서 K-pop 아이돌 그룹/멤버 정보를 실시간으로 가져오는 파서 모듈 생성 및 API 라우트 연동.

Purpose: kpopnet.json 패키지가 2023년 이후 업데이트되지 않아 최신 아이돌 정보가 부재함. selca.kastden.org (kpopnet.json의 원본 소스)에서 직접 데이터를 가져와 최신 데이터 접근 가능하게 함.
Output: selca.ts 파서 모듈, 수정된 API 라우트 3개
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-namuwiki-idol-data/DISCOVERY.md
@src/lib/kpop-data.ts
@src/app/api/kpop/groups/route.ts
@src/app/api/kpop/groups/[id]/members/route.ts
@src/app/api/kpop/members/route.ts

**기존 API 인터페이스 유지 필수:**
- KpopGroup: { id, name, name_original, memberCount }
- KpopMember: { id, name, name_original }
- KpopMemberWithGroup: { id, name, name_original, group: { id, name, name_original } | null }
</context>

<tasks>

<task type="auto">
  <name>Task 1: selca.ts 파서 모듈 생성</name>
  <files>src/lib/parsers/selca.ts</files>
  <action>
selca.kastden.org에서 K-pop 데이터를 가져오는 파서 모듈 생성.

**구현할 함수들:**

1. `searchGroups(query: string): Promise<KpopGroup[]>`
   - URL: `https://selca.kastden.org/noona/group/` 페이지 파싱
   - HTML 테이블에서 그룹명(영어/한글) 추출
   - query와 부분 일치하는 그룹 필터링 (대소문자 무시)
   - 최대 10개 반환
   - id는 그룹 slug (URL에서 추출, 예: "ive", "nmixx")

2. `getGroupMembers(groupSlug: string): Promise<{ groupName: string, groupNameOriginal: string, members: KpopMember[] }>`
   - URL: `https://selca.kastden.org/noona/group/{groupSlug}/`
   - 그룹 페이지에서 멤버 목록 테이블 파싱
   - member.id는 `{groupSlug}_{memberSlug}` 형식

3. `searchMembers(query: string): Promise<KpopMemberWithGroup[]>`
   - URL: `https://selca.kastden.org/noona/search/?pt=kpop&n={query}` (이름 검색)
   - 검색 결과에서 아이돌 정보 + 그룹 정보 파싱
   - 최대 10개 반환

**HTML 파싱 패턴 (DISCOVERY.md 참조):**
- 테이블 기반 데이터 (sortable table)
- 그룹 목록: 테이블 행에서 Name, Company, Fandom, Debut, Disband 컬럼
- 멤버 목록: 그룹 상세 페이지의 멤버 섹션

**주의사항:**
- User-Agent 헤더 설정 (봇 차단 방지)
- 타임아웃 5초 설정
- HTML 파싱에 cheerio 사용하지 말 것 (설치 불필요, 정규식 또는 DOMParser 대안)
- 서버 사이드에서만 실행되므로 node-html-parser 사용 가능 (설치 필요)

**에러 핸들링:**
- 네트워크 오류 시 빈 배열 반환
- 파싱 실패 시 console.error 후 빈 배열 반환
  </action>
  <verify>TypeScript 컴파일 성공: `npm run build` (파서 모듈만 import 테스트)</verify>
  <done>src/lib/parsers/selca.ts 파일 생성, searchGroups/getGroupMembers/searchMembers 함수 구현</done>
</task>

<task type="auto">
  <name>Task 2: API 라우트 수정 - selca 파서 연동</name>
  <files>src/app/api/kpop/groups/route.ts, src/app/api/kpop/groups/[id]/members/route.ts, src/app/api/kpop/members/route.ts</files>
  <action>
기존 kpop-data.ts 대신 selca.ts 파서를 사용하도록 API 라우트 수정.

**수정 내용:**

1. `/api/kpop/groups/route.ts`:
   - `import { searchGroups } from '@/lib/kpop-data'` → `import { searchGroups } from '@/lib/parsers/selca'`
   - 함수가 Promise 반환하므로 await 추가

2. `/api/kpop/groups/[id]/members/route.ts`:
   - `import { getGroupMembers } from '@/lib/kpop-data'` 제거
   - `import kpopData from 'kpopnet.json'` 제거
   - `import { getGroupMembers } from '@/lib/parsers/selca'` 추가
   - id 파라미터가 이제 groupSlug임 (숫자 ID 아닌 문자열 slug)
   - getGroupMembers가 { groupName, groupNameOriginal, members } 반환하므로 응답 구조 조정

3. `/api/kpop/members/route.ts`:
   - `import { searchMembers } from '@/lib/kpop-data'` → `import { searchMembers } from '@/lib/parsers/selca'`
   - await 추가

**응답 형식 유지:**
- 기존 BiasManager.tsx가 사용하는 응답 형식 그대로 유지
- 인터페이스 변경 없음
  </action>
  <verify>
1. `npm run build` 성공
2. `npm run dev` 후 브라우저에서 그룹 검색 테스트 (IVE, 아이브 등)
  </verify>
  <done>3개 API 라우트가 selca.ts 파서 사용, 기존 응답 형식 유지</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] `npm run dev` 실행 후 BiasManager에서 그룹 검색 작동 확인 (IVE, NMIXX 등 최신 그룹)
- [ ] 멤버 조회 작동 확인 (그룹 선택 시 멤버 목록 표시)
- [ ] 개별 멤버 검색 작동 확인 (장원영, Wonyoung 등)
</verification>

<success_criteria>
- selca.ts 파서 모듈이 selca.kastden.org에서 데이터를 가져옴
- 3개 API 라우트가 새 파서 사용
- BiasManager의 그룹 검색/멤버 조회 기능 정상 작동
- 최신 그룹 (2022-2024년 데뷔) 검색 가능
</success_criteria>

<output>
After completion, create `.planning/phases/22-namuwiki-idol-data/22-01-SUMMARY.md`:

# Phase 22 Plan 01: Selca Parser Integration Summary

**selca.kastden.org 파서 연동으로 최신 K-pop 데이터 접근 가능**

## Accomplishments
- selca.ts 파서 모듈 생성
- API 라우트 3개 수정

## Files Created/Modified
- `src/lib/parsers/selca.ts` - 새 파서 모듈
- `src/app/api/kpop/groups/route.ts` - selca 파서 사용
- `src/app/api/kpop/groups/[id]/members/route.ts` - selca 파서 사용
- `src/app/api/kpop/members/route.ts` - selca 파서 사용

## Decisions Made
[Any decisions during implementation]

## Issues Encountered
[Any issues and resolutions]

## Next Step
Ready for 22-02-PLAN.md (kpopnet.json 의존성 제거)
</output>
