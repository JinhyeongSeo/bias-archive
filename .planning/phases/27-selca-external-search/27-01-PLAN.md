---
phase: 27-selca-external-search
plan: 01
type: execute
depends_on: []
files_modified: [
  src/app/api/search/selca/route.ts,
  src/components/ExternalSearch.tsx,
  src/components/LinkForm.tsx,
  src/components/Timeline.tsx
]
---

<objective>
selca.kastden.org를 외부 검색 플랫폼으로 추가하여 아이돌별 셀카/영상 콘텐츠 검색 기능 구현

Purpose: 기존 YouTube, Twitter, heye, kgirls에 이어 K-pop 전문 셀카 사이트인 selca.kastden.org를 외부 검색에 통합하여 더 풍부한 콘텐츠 발견 가능
Output: UnifiedSearch 모달에 selca 탭 추가, 아이돌별 미디어 검색/저장 기능
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 관련 이전 Phase Summary
@.planning/phases/04-search-filter/04-02-SUMMARY.md
@.planning/phases/08-heye-parser/08-02-SUMMARY.md
@.planning/phases/09-kgirls-parser/09-02-SUMMARY.md
@.planning/phases/22-namuwiki-idol-data/22-01-SUMMARY.md

# 관련 소스 파일
@src/components/ExternalSearch.tsx
@src/lib/parsers/selca.ts
@src/app/api/search/heye/route.ts

**기술 스택:**
- selca.kastden.org 파서 이미 존재 (Phase 22에서 K-pop 데이터용으로 생성)
- node-html-parser로 HTML 파싱
- 외부 검색 UI 패턴 확립 (Phase 4, 8, 9에서)
- 페이지네이션 패턴 확립 (heye, kgirls에서)

**확립된 패턴:**
- ExternalSearch 컴포넌트: 플랫폼별 탭, 검색 결과 목록, 저장 버튼
- /api/search/[platform] API 라우트 패턴
- LinkForm/Timeline 플랫폼 색상 추가
- 검색 캐시 및 조회 기록 지원

**제약사항:**
- selca.kastden.org는 아이돌 개인 페이지(/owner/[slug]/)에서만 미디어 목록 제공
- 키워드 검색은 아이돌/그룹 이름으로만 가능 (기존 selca 파서의 searchMembers 활용)
- 페이지네이션은 max_time_id 파라미터 사용
- 썸네일: /thumb/[ID].jpg, 원본 링크: /media/[ID]/ 또는 /original/[ID]/

**selca.kastden.org 구조 분석:**
- 개인 페이지 URL: https://selca.kastden.org/owner/[slug]/
- 미디어 아이템: 썸네일 이미지 + 메타데이터 (게시 시간, 플랫폼, 캡션)
- 페이지네이션: "Next page" 버튼, max_time_id 파라미터
- 필터링: ephemeral, favorites, sort, reverse, time range
- HTML 구조: img[src^="/thumb/"], a[href^="/media/"] 또는 a[href^="/original/"]
</context>

<tasks>

<task type="auto">
  <name>Task 1: selca 검색 API 라우트 생성</name>
  <files>src/app/api/search/selca/route.ts</files>
  <action>
  selca.kastden.org 검색 API 엔드포인트 생성:

  1. GET /api/search/selca?query=아이돌이름&page=1 형식
  2. query 파라미터로 아이돌/그룹 검색:
     - 먼저 기존 selca 파서의 searchMembers(query) 호출하여 매칭되는 아이돌 찾기
     - 가장 관련성 높은 아이돌 1명 선택 (첫 번째 결과)
     - 해당 아이돌의 slug로 개인 페이지 HTML fetch
  3. node-html-parser로 미디어 목록 파싱:
     - 썸네일: img[src^="/thumb/"] selector
     - 링크: 썸네일을 감싼 a[href^="/media/"] 또는 a[href^="/original/"]
     - 제목/캡션: 각 미디어 아이템의 텍스트 콘텐츠 (없으면 빈 문자열)
     - 게시 시간: "Posted by ... to ... at [날짜]" 패턴에서 추출
  4. 페이지네이션:
     - page > 1이면 max_time_id 파라미터 추가
     - "Next page" 링크의 href에서 max_time_id 추출
     - 다음 페이지 존재 여부를 hasNextPage로 반환
  5. 반환 형식:
     ```typescript
     interface SelcaSearchResult {
       url: string // https://selca.kastden.org/media/[ID]/ 형식
       title: string // 캡션 또는 빈 문자열
       thumbnailUrl: string // https://selca.kastden.org/thumb/[ID].jpg
       author: string // 아이돌 이름
     }
     ```
  6. 에러 처리:
     - query 누락 시 400
     - 아이돌 검색 실패 시 404 (매칭되는 아이돌 없음)
     - HTML 파싱 실패 시 500

  주의사항:
  - heye/kgirls API 라우트와 동일한 구조 유지 (일관성)
  - node-html-parser 사용 (기존 selca 파서와 동일)
  - 5초 fetch timeout 적용
  - User-Agent 헤더 추가 (selca 파서와 동일)
  </action>
  <verify>
  - npm run build 성공
  - curl "http://localhost:3000/api/search/selca?query=yujin" → 200 OK, 결과 배열 반환
  - curl "http://localhost:3000/api/search/selca?query=존재하지않는아이돌" → 404
  - curl "http://localhost:3000/api/search/selca" → 400 (query 누락)
  </verify>
  <done>
  - selca 검색 API 라우트 생성됨
  - 아이돌 검색 → 개인 페이지 미디어 파싱 동작
  - 페이지네이션 지원 (max_time_id)
  - TypeScript 타입 에러 없음
  </done>
</task>

<task type="auto">
  <name>Task 2: ExternalSearch에 selca 탭 추가</name>
  <files>src/components/ExternalSearch.tsx, src/components/LinkForm.tsx, src/components/Timeline.tsx</files>
  <action>
  ExternalSearch 컴포넌트에 selca.kastden.org 검색 탭 추가:

  1. ExternalSearch.tsx:
     - Platform 타입에 'selca' 추가
     - SelcaResult 인터페이스 추가 (url, title, thumbnailUrl, author)
     - selcaPage, selcaTotalPages 페이지네이션 상태 추가
     - handleSearch에 selca 케이스 추가:
       - /api/search/selca?query={query}&page={page} 호출
       - 응답에서 hasNextPage로 selcaTotalPages 업데이트
     - 탭 버튼에 "Selca" 추가 (보라색 테마: bg-purple-500/10, text-purple-600)
     - 검색 결과 렌더링 (selca 케이스):
       - 썸네일, 제목(캡션), 아이돌 이름, 저장 버튼
       - 페이지네이션 버튼 (이전/다음)
     - 플랫폼 배지에 selca 추가 (보라색)

  2. LinkForm.tsx:
     - platformColors에 selca: 'purple' 추가

  3. Timeline.tsx:
     - platformColors에 selca: 'text-purple-600 bg-purple-50' 추가

  주의사항:
  - heye(오렌지), kgirls(핑크)와 동일한 UI 패턴 적용
  - 썸네일이 없을 경우 placeholder 표시
  - 캡션이 너무 길면 truncate (max 2줄)
  - framer-motion 애니메이션 적용 (기존 패턴)
  </action>
  <verify>
  - npm run dev 실행
  - UnifiedSearch 모달 열기 → Selca 탭 표시됨
  - 검색어 입력 (예: "yujin") → 결과 표시됨
  - 썸네일 이미지 정상 로드
  - 페이지네이션 버튼 작동
  - 저장 버튼 클릭 → 링크 저장됨
  - 저장된 링크 LinkForm/Timeline에서 보라색 배지 표시됨
  </verify>
  <done>
  - ExternalSearch에 selca 탭 추가됨
  - 검색 결과 UI 정상 동작
  - 페이지네이션 작동
  - LinkForm/Timeline 플랫폼 색상 추가됨
  - 애니메이션 적용됨
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build 성공 (TypeScript 에러 없음)
- [ ] npm run dev로 개발 서버 실행
- [ ] UnifiedSearch 모달에서 Selca 탭 표시 확인
- [ ] 검색 기능 동작 확인 (예: "yujin", "ive wonyoung")
- [ ] 검색 결과에 썸네일, 캡션, 저장 버튼 정상 표시
- [ ] 페이지네이션 (다음 페이지) 동작 확인
- [ ] 검색 결과에서 저장 → LinkList에 추가 확인
- [ ] 저장된 selca 링크의 플랫폼 배지 색상 확인 (보라색)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- selca.kastden.org 검색 기능이 외부 검색 모달에 통합됨
- 아이돌별 셀카/영상 콘텐츠 검색 및 저장 가능
- 기존 외부 검색 플랫폼(YouTube, Twitter, heye, kgirls)과 동일한 UX
- No TypeScript errors or warnings
  </success_criteria>

<output>
After completion, create `.planning/phases/27-selca-external-search/27-01-SUMMARY.md`:

---
phase: 27-selca-external-search
plan: 01
subsystem: search
tags: [selca, external-search, node-html-parser, pagination]

requires:
  - phase: 22-namuwiki-idol-data
    provides: selca.kastden.org parser module
  - phase: 04-search-filter
    provides: ExternalSearch component pattern
provides:
  - selca.kastden.org keyword search in external search modal
  - Pagination support for selca search results
  - Idol-specific media content discovery
affects: []

tech-stack:
  added: []
  patterns: [idol-based media search, selca platform integration]

key-files:
  created: [src/app/api/search/selca/route.ts]
  modified: [src/components/ExternalSearch.tsx, src/components/LinkForm.tsx, src/components/Timeline.tsx]

key-decisions:
  - "아이돌 개인 페이지 기반 검색 (키워드로 아이돌 찾기 → 개인 페이지 미디어 파싱)"
  - "보라색 테마로 selca 플랫폼 구분"
  - "max_time_id 파라미터로 페이지네이션 구현"

patterns-established:
  - "아이돌 검색 → 개인 페이지 미디어 목록 파싱 패턴"

issues-created: []

duration: TBD
completed: TBD
---

# Phase 27 Plan 1: Selca External Search Summary

**selca.kastden.org 외부 검색 통합 - K-pop 전문 셀카/영상 콘텐츠 검색 기능**

## Performance

- **Duration:** TBD
- **Started:** TBD
- **Completed:** TBD
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- selca.kastden.org 검색 API 생성 (/api/search/selca)
- ExternalSearch에 selca 탭 추가 (보라색 테마)
- 아이돌별 미디어 검색 및 저장 기능
- 페이지네이션 UI 구현 (max_time_id 파라미터)
- selca 플랫폼 색상 추가 (LinkForm, Timeline)

## Task Commits

1. **Task 1: selca 검색 API 라우트 생성** - (commit hash) (feat)
2. **Task 2: ExternalSearch selca 탭 추가** - (commit hash) (feat)

**Plan metadata:** (this commit) (docs: complete plan)

## Files Created/Modified

- `src/app/api/search/selca/route.ts` - selca.kastden.org 검색 API (node-html-parser)
- `src/components/ExternalSearch.tsx` - selca 탭, 페이지네이션 상태/UI, 보라색 테마
- `src/components/LinkForm.tsx` - selca 플랫폼 색상 추가
- `src/components/Timeline.tsx` - selca 플랫폼 색상 추가

## Decisions Made

- **아이돌 개인 페이지 기반**: selca.kastden.org는 검색 엔드포인트가 URL 기반이므로, 키워드로 아이돌을 찾은 뒤 개인 페이지(/owner/[slug]/)에서 미디어 목록 파싱
- **보라색 테마**: selca 플랫폼 구분을 위해 보라색 배지 및 버튼 스타일 적용
- **max_time_id 페이지네이션**: "Next page" 링크에서 max_time_id 파라미터 추출하여 다음 페이지 로드

## Deviations from Plan

(To be filled during execution)

## Issues Encountered

(To be filled during execution)

## Next Phase Readiness

- Phase 27 complete - selca.kastden.org 외부 검색 기능 완성
- 전체 로드맵 완료 (27/27 phases)

---
*Phase: 27-selca-external-search*
*Completed: TBD*
</output>
