---
phase: 02-link-management
plan: 03
type: execute
depends_on: ["02-02"]
files_modified: [src/lib/metadata.ts, src/lib/parsers/youtube.ts, src/lib/parsers/twitter.ts, src/lib/parsers/weverse.ts]
---

<objective>
플랫폼별 메타데이터 파서 고도화

Purpose: YouTube, Twitter, Weverse 각 플랫폼의 특성에 맞는 메타데이터 추출 로직 구현
Output: 플랫폼별 최적화된 파서 + 날짜 추출 + 에러 처리 개선
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-link-management/02-02-SUMMARY.md

@src/lib/metadata.ts

**Tech stack available:** Next.js 16, React 19, Tailwind, Supabase, open-graph-scraper
**Established patterns:** metadata.ts의 extractMetadata 함수

**플랫폼별 특징:**
- YouTube: 업로드 날짜, 채널명, 고화질 썸네일 (maxresdefault)
- Twitter/X: 트윗 작성자, 트윗 텍스트, 미디어 타입
- Weverse: 아티스트명, 게시 날짜 (한국어 인터페이스)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 플랫폼별 파서 모듈 분리</name>
  <files>src/lib/parsers/youtube.ts, src/lib/parsers/twitter.ts, src/lib/parsers/weverse.ts, src/lib/parsers/generic.ts, src/lib/parsers/index.ts</files>
  <action>
1. `src/lib/parsers/` 디렉토리 생성

2. `src/lib/parsers/youtube.ts` 생성:
   - parseYouTube(url): VideoMetadata
   - oEmbed API 호출 + 추가 처리
   - 썸네일 URL을 maxresdefault로 변환 (https://img.youtube.com/vi/{videoId}/maxresdefault.jpg)
   - videoId 추출 (youtube.com/watch?v=, youtu.be/, youtube.com/shorts/)
   - 업로드 날짜는 oEmbed에서 제공되지 않음 → null 처리

3. `src/lib/parsers/twitter.ts` 생성:
   - parseTwitter(url): VideoMetadata
   - oEmbed API 호출
   - 작성자명 추출 (author_name)
   - 트윗 텍스트에서 첫 줄을 title로 사용
   - 미디어 썸네일은 oEmbed에서 직접 제공되지 않음 → null 처리 (Phase 3에서 개선 가능)

4. `src/lib/parsers/weverse.ts` 생성:
   - parseWeverse(url): VideoMetadata
   - open-graph-scraper로 OG 메타데이터 추출
   - og:title, og:image, og:description 파싱
   - URL 패턴: weverse.io/artist/media, weverse.io/artist/moments

5. `src/lib/parsers/generic.ts` 생성:
   - parseGeneric(url): VideoMetadata
   - open-graph-scraper 사용
   - OG/Twitter Card 메타데이터 추출

6. `src/lib/parsers/index.ts` 생성:
   - 통합 export
   - 타입 정의: VideoMetadata

**주의사항:**
- 각 파서에서 에러 발생 시 기본값 반환 (title: URL, thumbnail: null)
- 타임아웃 설정 (개별 파서당 5초)
- 네트워크 에러와 파싱 에러 구분
  </action>
  <verify>각 파서를 개별적으로 테스트하여 메타데이터 추출 확인</verify>
  <done>플랫폼별 파서 모듈 분리 완료, 각각 독립적으로 동작</done>
</task>

<task type="auto">
  <name>Task 2: metadata.ts 리팩토링 및 에러 처리 개선</name>
  <files>src/lib/metadata.ts</files>
  <action>
1. `src/lib/metadata.ts` 리팩토링:
   - 파서 모듈 import (from './parsers')
   - extractMetadata 함수를 파서 호출로 변경
   - 플랫폼 감지 → 해당 파서 호출 → 결과 반환

2. 에러 처리 개선:
   - MetadataError 커스텀 에러 클래스 생성
   - 에러 유형 구분: INVALID_URL, NETWORK_ERROR, PARSE_ERROR, TIMEOUT
   - 각 에러에 대한 사용자 친화적 메시지

3. 재시도 로직:
   - 네트워크 에러 시 1회 재시도
   - 재시도 간격 1초

4. 결과 정규화:
   - 모든 파서 결과를 통일된 VideoMetadata 형식으로
   - 빈 문자열은 null로 변환
   - 썸네일 URL 유효성 검사

**주의사항:**
- 기존 API 동작 유지 (하위 호환성)
- 로깅 추가 (console.error for 개발 환경)
  </action>
  <verify>다양한 URL 테스트: 정상 URL, 존재하지 않는 영상, 비공개 영상, 잘못된 형식</verify>
  <done>리팩토링 완료, 에러 처리 개선, 모든 플랫폼 테스트 통과</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>플랫폼별 파서 모듈 및 고도화된 메타데이터 추출</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. 테스트 URL 입력:
       - YouTube: https://www.youtube.com/watch?v=dQw4w9WgXcQ
       - YouTube Shorts: https://www.youtube.com/shorts/xxx
       - Twitter: https://twitter.com/username/status/123
       - X.com: https://x.com/username/status/123
       - Weverse: (실제 Weverse 링크가 있다면 테스트)
       - 일반 URL: https://example.com
    3. 각 URL에서 썸네일, 제목, 플랫폼 뱃지 확인
    4. 잘못된 URL 입력 시 에러 메시지 확인
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 에러 없음
- [ ] YouTube URL: 고화질 썸네일 + 제목 추출
- [ ] Twitter URL: 작성자명 + 제목 추출
- [ ] 일반 URL: OG 메타데이터 추출
- [ ] 에러 URL: 적절한 에러 메시지
- [ ] TypeScript 에러 없음
</verification>

<success_criteria>

- 플랫폼별 파서 모듈 분리 완료
- 각 플랫폼 최적화된 메타데이터 추출
- 에러 처리 및 재시도 로직 구현
- Phase 2 Link Management 완료
</success_criteria>

<output>
After completion, create `.planning/phases/02-link-management/02-03-SUMMARY.md`
</output>
