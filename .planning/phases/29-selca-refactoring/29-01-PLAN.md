---
phase: 29-selca-refactoring
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/parsers/selca.ts
  - src/app/api/search/selca/route.ts
  - src/lib/selca-types.ts
domain: []
---

<objective>
selca 관련 코드 리팩토링 - 중복 제거, 캐시 로직 수정, 미사용 코드 제거, 타입 일관성 확보

Purpose: Phase 27-28 동안 급하게 추가된 selca 기능의 코드 품질 개선. 유지보수성 향상 및 잠재적 버그 제거.
Output: 깔끔하게 정리된 selca 파서 및 검색 API, 공통 타입 정의
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-selca-search-ux/28-02-SUMMARY.md
@src/lib/parsers/selca.ts
@src/app/api/search/selca/route.ts
@src/app/api/kpop/groups/route.ts
@src/app/api/kpop/members/route.ts

**Phase 28에서 식별된 문제점:**
- slug 형식 감지 로직 추가로 인한 복잡도 증가
- fetchAllIdols() 함수 미사용 (Phase 28-01 실패 후)
- 중복된 fetchHtml() 함수 (selca.ts, route.ts)
- groupsCache 초기화 및 업데이트 로직 문제
- 타입 정의 중복 (SelcaResult 등)

**제약사항:**
- 기존 API 인터페이스 유지 (BiasManager, UnifiedSearch 호환성)
- 캐시 동작 변경 없이 개선만 수행
- 외부 의존성 추가 없이 내부 코드만 정리
</context>

<tasks>

<task type="auto">
  <name>Task 1: 공통 타입 파일 생성</name>
  <files>src/lib/selca-types.ts</files>
  <action>
  selca 관련 공통 타입을 한 곳에 모아 정의:
  - KpopGroup, KpopMember, KpopMemberWithGroup
  - SelcaSearchResult, SelcaSearchResponse
  - 캐시 관련 타입: CacheEntry<T>

  모든 타입에 JSDoc 주석 추가. export로 내보내기.
  </action>
  <verify>tsc --noEmit 성공, src/lib/selca-types.ts 파일 생성 확인</verify>
  <done>공통 타입 파일 생성, 모든 타입이 export됨</done>
</task>

<task type="auto">
  <name>Task 2: selca.ts 리팩토링</name>
  <files>src/lib/parsers/selca.ts</files>
  <action>
  1. src/lib/selca-types.ts에서 타입 import
  2. 중복 타입 정의 제거
  3. groupsCache 초기화 수정: null → undefined, 업데이트 로직을 직접 할당으로 변경
  4. fetchAllIdols() 함수 제거 (Phase 28-01 실패 후 미사용)
  5. idolsCache 관련 코드 제거 (fetchAllIdols와 함께)
  6. searchMembers() 함수 단순화: fetchAllIdols() 제거로 인해 더 이상 사용되지 않음을 명시하거나, 향후 사용을 위해 유지할지 결정
     → 유지: BiasManager에서 개별 멤버 검색 시 사용 가능성 있음. 단, 500+ 아이돌 로드 문제는 주석으로 경고 추가.
  7. 모든 함수에 JSDoc 주석 추가 (용도, 캐시 동작, 주의사항)

  **주의:** API 인터페이스 변경 금지. searchGroups, getGroupMembers, searchMembers 시그니처 유지.
  </action>
  <verify>npm run build 성공, 기존 API 호출 모두 작동</verify>
  <done>타입 중복 제거, 미사용 코드 제거, JSDoc 추가, 캐시 로직 개선</done>
</task>

<task type="auto">
  <name>Task 3: selca 검색 API 리팩토링</name>
  <files>src/app/api/search/selca/route.ts</files>
  <action>
  1. src/lib/selca-types.ts에서 타입 import
  2. 중복 타입 정의 제거 (SelcaSearchResult, SelcaSearchResponse)
  3. fetchHtml() 함수 제거 → selca.ts에서 export하여 재사용
     - selca.ts에 export async function fetchHtmlFromSelca(url: string) 추가
     - route.ts에서 import하여 사용
  4. slug 감지 정규식을 상수로 분리: const SLUG_PATTERN = /^[a-z0-9_]+$/
  5. 에러 메시지 일관성 개선 (한글 메시지 통일)
  6. 주석 추가: slug 직접 사용 로직, 페이지네이션 미구현 이유

  **변경 금지:** API 엔드포인트, 응답 형식, 쿼리 파라미터
  </action>
  <verify>curl localhost:3000/api/search/selca?query=윈터 성공, npm run build 성공</verify>
  <done>중복 코드 제거, fetchHtml 재사용, 코드 가독성 향상</done>
</task>

<task type="auto">
  <name>Task 4: 타입 import 업데이트</name>
  <files>
    src/app/api/kpop/groups/route.ts,
    src/app/api/kpop/members/route.ts,
    src/components/BiasManager.tsx
  </files>
  <action>
  selca.ts에서 타입을 import하는 모든 파일 업데이트:
  - 기존: import { KpopGroup } from '@/lib/parsers/selca'
  - 변경: import { KpopGroup } from '@/lib/selca-types'

  영향받는 파일들:
  1. src/app/api/kpop/groups/route.ts - searchGroups 함수 import는 유지, 타입만 변경
  2. src/app/api/kpop/members/route.ts - searchMembers 함수 import는 유지, 타입만 변경
  3. src/components/BiasManager.tsx - KpopGroup, KpopMember 타입 import 경로 변경

  **중요:** 함수 import는 여전히 '@/lib/parsers/selca'에서, 타입만 '@/lib/selca-types'로 분리
  </action>
  <verify>tsc --noEmit 성공, npm run build 성공</verify>
  <done>모든 파일이 새 타입 경로 사용, 빌드 에러 없음</done>
</task>

<task type="auto">
  <name>Task 5: 코드 검증 및 테스트</name>
  <files>N/A</files>
  <action>
  1. TypeScript 컴파일 확인: npm run build
  2. 개발 서버 실행: npm run dev
  3. selca 검색 테스트:
     - UnifiedSearch에서 "윈터" 검색 (Bias 매칭)
     - ExternalSearch selca 탭에서 "카리나" 검색 (직접 검색)
  4. BiasManager 그룹 추가 테스트:
     - "IVE" 검색하여 멤버 자동 추가 (kpop/groups API)
  5. ESLint 실행: npm run lint

  모든 기능이 리팩토링 전과 동일하게 작동해야 함.
  </action>
  <verify>모든 테스트 통과, 에러 없음, ESLint 경고 없음</verify>
  <done>리팩토링 후에도 모든 기능 정상 작동 확인</done>
</task>

</tasks>

<verification>
리팩토링 완료 전 확인사항:
- [ ] npm run build 성공 (TypeScript 에러 없음)
- [ ] npm run lint 성공 (ESLint 경고 없음)
- [ ] selca 검색 기능 작동 (UnifiedSearch, ExternalSearch)
- [ ] BiasManager 그룹 추가 기능 작동
- [ ] 중복 코드 제거됨 (fetchHtml)
- [ ] 미사용 코드 제거됨 (fetchAllIdols, idolsCache)
- [ ] 타입 중복 제거됨 (selca-types.ts로 통합)
- [ ] JSDoc 주석 추가됨
</verification>

<success_criteria>

- 모든 tasks 완료
- TypeScript 컴파일 에러 없음
- ESLint 경고 없음
- selca 검색 기능 정상 작동 (리팩토링 전과 동일)
- BiasManager 그룹 추가 기능 정상 작동
- 코드 중복 제거 및 가독성 향상
  </success_criteria>

<output>
완료 후 `.planning/phases/29-selca-refactoring/29-01-SUMMARY.md` 생성:

# Phase 29 Plan 01: Selca Refactoring Summary

**selca 관련 코드 리팩토링 완료 - 중복 제거, 타입 통합, 미사용 코드 제거**

## Accomplishments

- 공통 타입 파일 생성 (src/lib/selca-types.ts)
- selca.ts 리팩토링: 중복 타입 제거, 캐시 로직 개선, fetchAllIdols 제거
- selca 검색 API 리팩토링: fetchHtml 재사용, slug 패턴 상수화
- 타입 import 경로 업데이트 (kpop API, BiasManager)
- JSDoc 주석 추가 및 코드 가독성 향상

## Files Created/Modified

- `src/lib/selca-types.ts` - 신규 생성: 공통 타입 정의
- `src/lib/parsers/selca.ts` - 리팩토링: 중복 제거, 미사용 코드 제거, fetchHtmlFromSelca export
- `src/app/api/search/selca/route.ts` - 리팩토링: fetchHtml 재사용, 타입 import
- `src/app/api/kpop/groups/route.ts` - 타입 import 경로 변경
- `src/app/api/kpop/members/route.ts` - 타입 import 경로 변경
- `src/components/BiasManager.tsx` - 타입 import 경로 변경 (필요 시)

## Decisions Made

1. **fetchAllIdols() 제거**: Phase 28-01 실패 후 사용되지 않음, 500+ 아이돌 로드로 인한 타임아웃 문제
2. **searchMembers() 유지**: BiasManager에서 개별 멤버 검색 시 사용 가능성 있음, 주석으로 주의사항 명시
3. **타입 분리**: selca-types.ts로 공통 타입 통합, import 경로 명확화

## Issues Encountered

[리팩토링 중 발견된 문제 기록]

## Next Phase Readiness

- selca 코드 정리 완료
- Phase 30 (Selca Infinite Scroll) 준비 완료
</output>
