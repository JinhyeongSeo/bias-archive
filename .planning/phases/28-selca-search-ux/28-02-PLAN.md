---
phase: 28-selca-search-ux
plan: 02
---

<objective>
Selca 검색을 Bias 데이터 기반으로 개선 - selca_slug 저장 및 활용

**Why:** 현재 fetchAllIdols() 방식은 500+ 아이돌 페이지 방문으로 15초 타임아웃 초과
**What:** Bias에 selca_slug 저장하고, 검색 시 Bias 매칭으로 즉시 검색
**Output:** 타임아웃 없이 즉시 검색 가능, 사용자가 실제 검색할 아이돌만 데이터 저장
</objective>

<context>
**28-01 문제점:**
- `fetchAllIdols()` 호출 시 500+ 아이돌의 개별 페이지를 병렬로 방문
- 15초 타임아웃 초과로 검색 실패
- 사용자가 검색하지 않을 아이돌 데이터까지 모두 가져옴

**더 나은 접근:**
- BiasManager에서 최애 추가 시 `selca_slug` (예: "aespa_winter") 저장
- Selca 검색 시 Bias 목록에서 매칭 → 바로 검색
- 500+ 아이돌 데이터 불필요

**참고:**
- selca.kastden.org URL 형식: `/owner/{selca_slug}/`
- `getGroupMembers()` API에서 이미 `id` (selca_slug) 반환 중
</context>

<tasks>

<task type="auto">
  <name>Task 1: biases 테이블에 selca_slug 컬럼 추가</name>
  <files>supabase/migrations/</files>
  <action>
  마이그레이션 파일 생성:

  ```sql
  -- Add selca_slug column to biases table
  ALTER TABLE biases ADD COLUMN selca_slug text;

  -- Create index for faster lookups
  CREATE INDEX idx_biases_selca_slug ON biases(selca_slug);

  -- Add comment
  COMMENT ON COLUMN biases.selca_slug IS 'selca.kastden.org idol slug (e.g., aespa_winter)';
  ```

  파일명: `20260116_add_selca_slug_to_biases.sql`

  실행: `npx supabase db push`
  </action>
  <verify>
  - biases 테이블에 selca_slug 컬럼 존재
  - 인덱스 생성 확인
  - 기존 데이터 영향 없음 (nullable)
  </verify>
  <done>
  - 마이그레이션 파일 생성됨
  - DB에 적용 완료
  - 인덱스 생성 완료
  </done>
</task>

<task type="auto">
  <name>Task 2: Bias 타입에 selca_slug 추가</name>
  <files>src/types/database.ts</files>
  <action>
  Bias 인터페이스에 selca_slug 필드 추가:

  ```typescript
  export interface Bias {
    id: string
    name: string
    name_en: string | null
    name_ko: string | null
    group_id: string | null
    sort_order: number
    user_id: string
    created_at: string
    selca_slug: string | null  // ← NEW
  }
  ```
  </action>
  <verify>
  - Bias 타입에 selca_slug 필드 있음
  - TypeScript 에러 없음
  </verify>
  <done>
  - Bias 타입 업데이트 완료
  </done>
</task>

<task type="auto">
  <name>Task 3: BiasManager에서 selca_slug 저장</name>
  <files>src/app/api/kpop/groups/[id]/members/route.ts, src/components/BiasManager.tsx</files>
  <action>
  1. API 응답에 selca_slug 포함 (이미 `id` 필드로 반환 중):
     ```typescript
     // /api/kpop/groups/[id]/members/route.ts
     // getGroupMembers() 호출 결과의 members[].id가 selca_slug
     ```

  2. BiasManager에서 Bias 추가 시 selca_slug 저장:
     ```typescript
     // BiasManager.tsx - handleAddMember
     const response = await fetch('/api/biases', {
       method: 'POST',
       body: JSON.stringify({
         name: member.name,
         name_en: member.name,
         name_ko: member.name_stage_ko || member.name_original,
         selca_slug: member.id,  // ← NEW: selca.kastden.org slug
         group_id: groupId,
       }),
     })
     ```

  3. Bias 일괄 추가 시에도 selca_slug 포함:
     ```typescript
     // handleAddAllMembers
     members.map(member => ({
       name: member.name,
       name_en: member.name,
       name_ko: member.name_stage_ko || member.name_original,
       selca_slug: member.id,  // ← NEW
       group_id: groupId,
     }))
     ```
  </action>
  <verify>
  - 새로 추가한 Bias에 selca_slug 저장됨
  - DB에서 selca_slug 값 확인 (예: "aespa_winter")
  </verify>
  <done>
  - BiasManager에서 selca_slug 저장 구현
  - 일괄 추가에도 적용
  </done>
</task>

<task type="auto">
  <name>Task 4: UnifiedSearch에서 Bias 매칭 후 검색</name>
  <files>src/components/UnifiedSearch.tsx</files>
  <action>
  searchSelca 함수 수정:

  ```typescript
  const searchSelca = async (
    searchQuery: string,
    page: number = 1
  ): Promise<{ results: EnrichedResult[]; hasMore: boolean }> => {
    // Step 1: Bias 목록에서 매칭 찾기
    const normalizedQuery = searchQuery.trim().toLowerCase();

    const matchedBias = biases.find(bias => {
      const nameMatch = bias.name.toLowerCase() === normalizedQuery;
      const nameEnMatch = bias.name_en?.toLowerCase() === normalizedQuery;
      const nameKoMatch = bias.name_ko?.toLowerCase() === normalizedQuery;
      return nameMatch || nameEnMatch || nameKoMatch;
    });

    // Step 2: selca_slug 사용 (있으면 바로 검색, 없으면 기존 방식)
    const queryToUse = matchedBias?.selca_slug || searchQuery;

    console.log(`[Selca Search] "${searchQuery}" → slug: "${queryToUse}"`);

    const params = new URLSearchParams({
      query: queryToUse,
      page: String(page),
      limit: String(API_FETCH_COUNT),
    });

    // ... 나머지 동일
  ```

  장점:
  - Bias에 있는 아이돌: 즉시 검색 (selca_slug 사용)
  - Bias에 없는 아이돌: 기존 방식 (searchMembers 호출)
  </action>
  <verify>
  - Bias에 등록된 아이돌 검색 시 즉시 응답
  - 콘솔에서 slug 변환 로그 확인
  - Bias에 없는 아이돌도 기존처럼 작동 (fallback)
  </verify>
  <done>
  - UnifiedSearch에서 Bias 매칭 구현
  - selca_slug 우선 사용
  - fallback 로직 유지
  </done>
</task>

<task type="auto">
  <name>Task 5: 기존 Bias에 selca_slug 백필 (선택)</name>
  <files>별도 스크립트 또는 수동</files>
  <action>
  기존에 추가된 Bias들에 selca_slug를 채우는 방법:

  **Option A: 수동 업데이트 (권장)**
  - 사용자가 Bias를 다시 추가하거나 편집할 때 자동으로 채워짐
  - 점진적으로 데이터 채워짐

  **Option B: 백필 스크립트**
  - `/api/kpop/members?query={bias.name}` 호출
  - 결과의 첫 번째 매치에서 `id` 가져와서 업데이트
  - 한 번만 실행

  **Option C: BiasManager UI에 "Selca 연동" 버튼**
  - 사용자가 원할 때 수동으로 연동
  - 각 Bias마다 selca slug 찾아서 저장
  </action>
  <verify>
  - 기존 Bias 중 일부에 selca_slug 값 있음
  </verify>
  <done>
  - 백필 전략 결정 (수동/자동/UI)
  - 필요시 구현
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Bias 기반 Selca 검색 구현:
  - biases 테이블에 selca_slug 컬럼 추가
  - BiasManager에서 selca_slug 저장
  - UnifiedSearch에서 Bias 매칭 후 즉시 검색
  - fallback으로 기존 방식 유지
  </what-built>
  <how-to-verify>
  1. 브라우저 새로고침 (Cmd+Shift+R)
  2. BiasManager에서 새 아이돌 추가 (예: aespa Winter)
  3. DB에서 selca_slug 확인:
     ```sql
     SELECT name, selca_slug FROM biases WHERE name LIKE '%Winter%';
     ```
     → selca_slug: "aespa_winter"

  4. 통합검색 모달 열기
  5. Selca 탭에서 "윈터" 검색
  6. 콘솔 확인: `[Selca Search] "윈터" → slug: "aespa_winter"`
  7. 즉시 결과 표시 (타임아웃 없음!)

  8. Bias에 없는 아이돌 검색:
     - "츄" 검색 → 기존 방식으로 검색 (느릴 수 있음)
  </how-to-verify>
  <resume-signal>Type "approved" if Bias-based search works, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] biases 테이블에 selca_slug 컬럼 존재
- [ ] 새로 추가한 Bias에 selca_slug 저장됨
- [ ] Bias 매칭 시 즉시 검색됨 (타임아웃 없음)
- [ ] Bias에 없는 아이돌도 기존처럼 작동 (fallback)
- [ ] 콘솔에서 slug 변환 로그 확인
</verification>

<success_criteria>
- Bias에 등록된 아이돌: 즉시 검색 (타임아웃 없음)
- Bias에 없는 아이돌: 기존 방식 (searchMembers 호출)
- Breaking change 없음: 모든 기존 검색 기능 유지
- 성능 개선: Bias 아이돌 검색 시 <1초
</success_criteria>

<notes>
**28-01 vs 28-02 비교:**

| 항목 | 28-01 (fetchAllIdols) | 28-02 (Bias slug) |
|------|---------------------|------------------|
| 검색 속도 | 10-30초 (최초) | <1초 (즉시) |
| 타임아웃 | 발생함 (15초) | 없음 |
| 데이터 범위 | 500+ 모든 아이돌 | 사용자 Bias만 |
| 유지보수 | 캐싱 관리 필요 | Bias 추가 시 자동 |
| 메모리 | 큼 | 작음 |

**권장:**
- 28-01은 revert
- 28-02로 재구현
</notes>

<output>
After completion, create `.planning/phases/28-selca-search-ux/28-02-SUMMARY.md`
</output>
