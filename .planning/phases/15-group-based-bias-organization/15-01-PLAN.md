---
phase: 15-group-based-bias-organization
plan: 01
type: execute
depends_on: []
files_modified:
  - supabase/migrations/20260114000002_groups_table.sql
  - src/types/database.ts
  - src/lib/biases.ts
  - src/lib/groups.ts
  - src/app/api/groups/route.ts
  - src/app/api/biases/batch/route.ts
domain: null
---

<objective>
groups 테이블을 생성하고 biases 테이블과 연결, 그룹 관련 API를 구현한다.

Purpose: 최애를 그룹별로 체계적으로 분류하기 위한 데이터 구조 확립
Output: groups 테이블, biases.group_id FK, 그룹 CRUD API, 그룹 일괄 추가 연동
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/11-bias-schema-extension/11-01-SUMMARY.md

# Key files:
@src/types/database.ts
@src/lib/biases.ts
@src/app/api/biases/batch/route.ts
@supabase/migrations/20260114000001_bias_multilingual.sql

**Established patterns:**
- Supabase migration으로 스키마 변경 (`npx supabase db push`)
- TypeScript 타입은 src/types/database.ts에서 수동 관리
- nullable FK로 하위 호환성 유지

**Constraining decisions:**
- 기존 group_name 텍스트 필드는 유지 (하위 호환성)
- 새 group_id FK는 nullable로 추가
- 그룹 일괄 추가 시 group 레코드 자동 생성 (있으면 재사용)
</context>

<tasks>

<task type="auto">
  <name>Task 1: groups 테이블 생성 및 biases.group_id FK 추가</name>
  <files>supabase/migrations/20260114000002_groups_table.sql, src/types/database.ts</files>
  <action>
1. Migration 파일 생성:
   - groups 테이블: id (UUID PK), name (TEXT NOT NULL), name_en (TEXT), name_ko (TEXT), created_at, updated_at
   - biases 테이블에 group_id (UUID, FK to groups.id, ON DELETE SET NULL) 추가
   - groups 테이블에 updated_at 트리거 추가
   - idx_biases_group_id 인덱스 추가

2. TypeScript 타입 업데이트 (src/types/database.ts):
   - groups 테이블 Row/Insert/Update 타입 추가
   - biases에 group_id 필드 추가
   - Group, GroupInsert, GroupUpdate export
   - BiasWithGroup 복합 타입 추가 (Bias & { group: Group | null })

3. Migration 실행: `npx supabase db push`
  </action>
  <verify>npx supabase db push 성공, npm run build 성공 (타입 에러 없음)</verify>
  <done>groups 테이블 생성됨, biases.group_id FK 추가됨, TypeScript 타입 정의됨</done>
</task>

<task type="auto">
  <name>Task 2: Groups CRUD 및 biases batch API 연동</name>
  <files>src/lib/groups.ts, src/app/api/groups/route.ts, src/app/api/biases/batch/route.ts, src/lib/biases.ts</files>
  <action>
1. src/lib/groups.ts 생성:
   - getGroups(): 모든 그룹 조회 (created_at desc)
   - getGroup(id): 단일 그룹 조회
   - getGroupByName(name: string): 이름으로 그룹 조회 (name, name_en, name_ko 중 하나라도 매칭)
   - createGroup(name, nameEn?, nameKo?): 그룹 생성
   - getOrCreateGroup(name, nameEn?, nameKo?): 있으면 반환, 없으면 생성

2. src/app/api/groups/route.ts 생성:
   - GET: 모든 그룹 목록 반환
   - POST: 새 그룹 생성 (name, nameEn, nameKo)

3. src/app/api/biases/batch/route.ts 수정:
   - 기존 groupName 대신 group 정보(name, nameEn, nameKo)로 getOrCreateGroup 호출
   - 반환된 group.id를 bias 레코드의 group_id에 저장
   - 기존 group_name 필드도 유지 (하위 호환성)

4. src/lib/biases.ts 수정:
   - createBias에 groupId 파라미터 추가 (optional)
   - getBiases에서 group 정보도 join하여 반환 (optional)
   - getBiasesWithGroups(): biases를 group 정보와 함께 조회
  </action>
  <verify>
- curl -X GET localhost:3000/api/groups 성공 (빈 배열 또는 그룹 목록)
- 그룹 일괄 추가 후 groups 테이블에 그룹 레코드 생성 확인
- npm run build 성공
  </verify>
  <done>
- Groups CRUD 함수 및 API 구현됨
- 그룹 일괄 추가 시 groups 테이블에 그룹 자동 생성
- biases.group_id에 FK 연결됨
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx supabase db push` 성공
- [ ] `npm run build` 성공 (TypeScript 에러 없음)
- [ ] groups API 응답 정상 (GET /api/groups)
- [ ] 그룹 일괄 추가 후 groups 테이블에 레코드 생성됨
</verification>

<success_criteria>

- groups 테이블 생성됨
- biases.group_id FK 추가됨
- Groups CRUD API 작동
- 그룹 일괄 추가 시 group 레코드 자동 생성됨
- 기존 기능 정상 작동 (하위 호환성)
</success_criteria>

<output>
After completion, create `.planning/phases/15-group-based-bias-organization/15-01-SUMMARY.md`:

# Phase 15 Plan 01: Groups Schema & API Summary

**[one-liner]**

## Accomplishments

- [outcomes]

## Files Created/Modified

- [files]

## Decisions Made

- [decisions]

## Issues Encountered

- [issues or "None"]

## Next Step

Ready for 15-02-PLAN.md (UI update)
</output>
