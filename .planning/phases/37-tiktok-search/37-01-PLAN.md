---
phase: 37-tiktok-search
plan: 01
type: execute
depends_on: []
files_modified:
  - src/types/platforms.ts
  - src/lib/parsers/tiktok.ts
  - src/lib/parsers/index.ts
  - src/app/api/search/tiktok/route.ts
  - src/app/api/metadata/route.ts
  - src/components/ExternalSearch.tsx
  - src/components/LinkCard.tsx
  - messages/ko.json
  - messages/en.json
---

<objective>
TikTok 검색 및 링크 저장 기능 추가

Purpose: 통합검색에서 TikTok 영상 검색 및 아카이브 저장 지원
Output: TikTok 탭이 추가된 ExternalSearch, TikTok URL 파서, TikTok 검색 API
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-tiktok-search/DISCOVERY.md

**참고 파일 (Instagram 구현 패턴):**
@src/app/api/search/instagram/route.ts
@src/lib/parsers/instagram.ts
@src/types/platforms.ts
@src/components/ExternalSearch.tsx

**결정 사항:**
- RapidAPI TikTok Scraper 사용 (tiktok-scraper7.p.rapidapi.com)
- 환경 변수: RAPIDAPI_KEY
- 무료 플랜: 월 500회 요청
</context>

<tasks>

<task type="auto">
  <name>Task 1: Platform 타입 및 TikTok 파서 추가</name>
  <files>src/types/platforms.ts, src/lib/parsers/tiktok.ts, src/lib/parsers/index.ts, src/app/api/metadata/route.ts</files>
  <action>
1. `src/types/platforms.ts` 수정:
   - Platform 타입에 `'tiktok'` 추가 (instagram 다음에)
   - SearchCachePlatform에 `'tiktok'` 추가
   - TikTokResult 인터페이스 추가 (InstagramResult와 유사)

2. `src/lib/parsers/tiktok.ts` 생성 (instagram.ts 참고):
   - parseTikTokUrl(): URL에서 username, videoId 추출
     - 패턴: `/@username/video/videoId`
     - 단축 URL: `vm.tiktok.com/XXXXX`
   - parseTikTok(url): HTML meta tag 파싱
     - og:title, og:image, og:description 추출
     - authorName 추출 (@ 패턴)
     - platform: 'tiktok' 반환
     - 폴백: URL 기반 정보 사용
   - 타임아웃: 8초 (Instagram과 동일)

3. `src/lib/parsers/index.ts` 수정:
   - `export { parseTikTok } from './tiktok'` 추가

4. `src/app/api/metadata/route.ts` 수정:
   - TikTok URL 감지 및 parseTikTok 호출 추가
   - 패턴: `tiktok.com`, `vm.tiktok.com`
  </action>
  <verify>
- TypeScript 컴파일 성공: `npx tsc --noEmit`
- TikTok URL 감지 테스트: metadata API가 tiktok.com URL 처리
  </verify>
  <done>
- Platform 타입에 'tiktok' 추가됨
- TikTok 파서가 메타데이터 추출 가능
- metadata API가 TikTok URL 처리
  </done>
</task>

<task type="auto">
  <name>Task 2: TikTok 검색 API 라우트 생성</name>
  <files>src/app/api/search/tiktok/route.ts</files>
  <action>
`src/app/api/search/tiktok/route.ts` 생성:

1. 환경 변수 체크: `RAPIDAPI_KEY`
   - 없으면 `{ notConfigured: true }` 반환

2. RapidAPI TikTok Scraper 호출:
   - Endpoint: `https://tiktok-scraper7.p.rapidapi.com/feed/search`
   - Headers:
     ```typescript
     {
       'x-rapidapi-host': 'tiktok-scraper7.p.rapidapi.com',
       'x-rapidapi-key': process.env.RAPIDAPI_KEY
     }
     ```
   - Query params:
     ```typescript
     {
       keywords: query,  // 검색어
       region: 'kr',     // 한국 지역 우선
       count: limit,     // 기본 30, 최대 30
       cursor: 0,        // 페이징
       publish_time: 0,  // 0=전체, 1=24시간, 7=이번주, 30=이번달, 90=3개월, 180=6개월
       sort_type: 0      // 0=관련성, 1=좋아요순, 2=최신순
     }
     ```

3. 결과 변환 (TikTokSearchResult 형식):
   - RapidAPI 응답 구조:
     ```typescript
     {
       data: {
         videos: [{
           video_id: string,
           title: string,        // 영상 설명
           cover: string,        // 썸네일
           play: string,         // 비디오 URL
           author: {
             unique_id: string,  // @username
             nickname: string    // 표시 이름
           }
         }]
       }
     }
     ```
   - 변환:
     ```typescript
     {
       url: `https://www.tiktok.com/@${author.unique_id}/video/${video_id}`,
       title: title.slice(0, 50) + (title.length > 50 ? '...' : ''),
       thumbnailUrl: cover,
       author: author.nickname || author.unique_id,
       media: [{ type: 'video', url: play }]
     }
     ```

4. 에러 처리:
   - Rate limit: 429 에러
   - API 키 문제: 500 에러
  </action>
  <verify>
- API 라우트 존재 확인: `ls src/app/api/search/tiktok/route.ts`
- TypeScript 컴파일: `npx tsc --noEmit`
  </verify>
  <done>
- TikTok 검색 API가 `/api/search/tiktok?q=검색어` 형식으로 동작
- notConfigured 응답 또는 검색 결과 반환
  </done>
</task>

<task type="auto">
  <name>Task 3: ExternalSearch UI에 TikTok 탭 추가</name>
  <files>src/components/ExternalSearch.tsx, src/components/LinkCard.tsx, messages/ko.json, messages/en.json</files>
  <action>
1. `src/components/ExternalSearch.tsx` 수정:
   - Platform 타입에 'tiktok' 추가 (로컬 타입)
   - TikTokResult 인터페이스 추가 (InstagramResult와 동일 구조)
   - 플랫폼 탭에 TikTok 추가 (Instagram 다음)
     - 색상: 검정/핫핑크 계열
     - 라벨: "TikTok"
   - searchTikTok 함수 추가:
     ```typescript
     const searchTikTok = async (searchQuery: string) => {
       const response = await fetch(`/api/search/tiktok?q=${encodeURIComponent(searchQuery)}&limit=30`)
       // Instagram과 동일한 결과 처리 패턴
     }
     ```
   - handleSearch에 tiktok case 추가
   - notConfigured 처리 추가
   - Platform notice 추가 (키워드 검색 안내)
   - getPlatformBadgeStyle, getPlatformLabel에 tiktok 추가

2. `src/components/LinkCard.tsx` 수정:
   - TikTok 플랫폼 아이콘 추가
   - 색상: 검정색 (#000000) 또는 핫핑크 (#ff0050)

3. `messages/ko.json` 수정:
   - "tiktok": "TikTok" 추가 (platform 섹션)
   - "tiktokNotConfigured": "TikTok 검색이 설정되지 않았습니다" 추가

4. `messages/en.json` 수정:
   - "tiktok": "TikTok" 추가
   - "tiktokNotConfigured": "TikTok search is not configured" 추가
  </action>
  <verify>
- 개발 서버 실행: `npm run dev`
- ExternalSearch 모달에서 TikTok 탭 표시 확인
- 빌드 성공: `npm run build`
  </verify>
  <done>
- ExternalSearch에 TikTok 탭 표시
- TikTok 검색 결과가 목록에 표시
- LinkCard에 TikTok 플랫폼 아이콘 표시
- 다국어 지원 완료
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 성공
- [ ] TikTok URL 저장 테스트: `https://www.tiktok.com/@username/video/123` 형식 URL 저장
- [ ] ExternalSearch에서 TikTok 탭 표시
- [ ] TikTok 검색 API 응답 (notConfigured 또는 결과)
- [ ] LinkCard에 TikTok 아이콘 표시
</verification>

<success_criteria>
- TikTok URL 파서 동작 (메타데이터 추출)
- TikTok 검색 API 동작 (RapidAPI 연동)
- ExternalSearch에 TikTok 탭 표시 및 검색 가능
- 검색 결과 아카이브 저장 가능
- LinkCard에 TikTok 플랫폼 아이콘 표시
- 빌드 성공
</success_criteria>

<output>
After completion, create `.planning/phases/37-tiktok-search/37-01-SUMMARY.md`:

# Phase 37 Plan 01: TikTok Search Summary

**TikTok 검색 및 링크 저장 기능 구현 완료**

## Accomplishments

- TikTok URL 파서 생성 (메타데이터 추출)
- RapidAPI TikTok Scraper 기반 검색 API 구현
- ExternalSearch에 TikTok 탭 추가
- LinkCard에 TikTok 플랫폼 아이콘 추가
- 다국어 지원 (ko/en)

## Files Created/Modified

- `src/types/platforms.ts` - Platform 타입에 tiktok 추가
- `src/lib/parsers/tiktok.ts` - TikTok URL 파서 (신규)
- `src/lib/parsers/index.ts` - parseTikTok export
- `src/app/api/search/tiktok/route.ts` - TikTok 검색 API (신규)
- `src/app/api/metadata/route.ts` - TikTok URL 처리 추가
- `src/components/ExternalSearch.tsx` - TikTok 탭 추가
- `src/components/LinkCard.tsx` - TikTok 아이콘 추가
- `messages/ko.json`, `messages/en.json` - 번역 추가

## Decisions Made

- RapidAPI tiktok-scraper7 사용 (월 500회 무료)
- 환경 변수: RAPIDAPI_KEY
- 키워드 기반 검색 (해시태그 아님)

## Issues Encountered

[구현 중 발생한 이슈]

## Next Step

Phase 37 complete
</output>
